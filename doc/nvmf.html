<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.13">
  <title>SPDK: NVMe over Fabrics Target</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-sm-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://ci.spdk.io/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('nvmf.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">NVMe over Fabrics Target </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section see"><dt>See also</dt><dd><a class="el" href="nvme.html#nvme_fabrics_host">NVMe over Fabrics Host Support</a></dd></dl>
<h1><a class="anchor" id="nvmf_getting_started"></a>
NVMe-oF Target Getting Started Guide</h1>
<p>The NVMe over Fabrics target is a user space application that presents block devices over the network using RDMA. It requires an RDMA-capable NIC with its corresponding OFED software package installed to run. The target should work on all flavors of RDMA, but it is currently tested against Mellanox NICs (RoCEv2) and Chelsio NICs (iWARP).</p>
<p>The NVMe over Fabrics specification defines subsystems that can be exported over the network. SPDK has chosen to call the software that exports these subsystems a "target", which is the term used for iSCSI. The specification refers to the "client" that connects to the target as a "host". Many people will also refer to the host as an "initiator", which is the equivalent thing in iSCSI parlance. SPDK will try to stick to the terms "target" and "host" to match the specification.</p>
<p>The Linux kernel also implements an NVMe-oF target and host, and SPDK is tested for interoperability with the Linux kernel implementations.</p>
<p>If you want to kill the application using signal, make sure use the SIGTERM, then the application will release all the share memory resource before exit, the SIGKILL will make the share memory resource have no chance to be released by application, you may need to release the resource manually.</p>
<h2><a class="anchor" id="nvmf_prereqs"></a>
Prerequisites</h2>
<p>This guide starts by assuming that you can already build the standard SPDK distribution on your platform. By default, the NVMe over Fabrics target is not built. To build nvmf_tgt there are some additional dependencies.</p>
<p>Fedora: </p><div class="fragment"><div class="line">dnf install libibverbs-devel librdmacm-devel</div></div><!-- fragment --><p>Ubuntu: </p><div class="fragment"><div class="line">apt-get install libibverbs-dev librdmacm-dev</div></div><!-- fragment --><p>Then build SPDK with RDMA enabled:</p>
<div class="fragment"><div class="line">./configure --with-rdma &lt;other config parameters&gt;</div><div class="line">make</div></div><!-- fragment --><p>Once built, the binary will be in <code>app/nvmf_tgt</code>.</p>
<h2><a class="anchor" id="nvmf_prereqs_verbs"></a>
Prerequisites for InfiniBand/RDMA Verbs</h2>
<p>Before starting our NVMe-oF target we must load the InfiniBand and RDMA modules that allow userspace processes to use InfiniBand/RDMA verbs directly.</p>
<div class="fragment"><div class="line">modprobe ib_cm</div><div class="line">modprobe ib_core</div><div class="line">modprobe ib_ucm</div><div class="line">modprobe ib_umad</div><div class="line">modprobe ib_uverbs</div><div class="line">modprobe iw_cm</div><div class="line">modprobe rdma_cm</div><div class="line">modprobe rdma_ucm</div></div><!-- fragment --><h2><a class="anchor" id="nvmf_prereqs_rdma_nics"></a>
Prerequisites for RDMA NICs</h2>
<p>Before starting our NVMe-oF target we must detect RDMA NICs and assign them IP addresses.</p>
<h3>Mellanox ConnectX-3 RDMA NICs</h3>
<div class="fragment"><div class="line">modprobe mlx4_core</div><div class="line">modprobe mlx4_ib</div><div class="line">modprobe mlx4_en</div></div><!-- fragment --><h3>Mellanox ConnectX-4 RDMA NICs</h3>
<div class="fragment"><div class="line">modprobe mlx5_core</div><div class="line">modprobe mlx5_ib</div></div><!-- fragment --><h3>Assigning IP addresses to RDMA NICs</h3>
<div class="fragment"><div class="line">ifconfig eth1 192.168.100.8 netmask 255.255.255.0 up</div><div class="line">ifconfig eth2 192.168.100.9 netmask 255.255.255.0 up</div></div><!-- fragment --><h2><a class="anchor" id="nvmf_config"></a>
Configuring the SPDK NVMe over Fabrics Target</h2>
<p>A <code>nvmf_tgt</code>-specific configuration file is used to configure the NVMe over Fabrics target. This file's primary purpose is to define subsystems. A fully documented example configuration file is located at <code>etc/spdk/nvmf.conf.in</code>.</p>
<p>You should make a copy of the example configuration file, modify it to suit your environment, and then run the nvmf_tgt application and pass it the configuration file using the -c option. Right now, the target requires elevated privileges (root) to run.</p>
<div class="fragment"><div class="line">app/nvmf_tgt/nvmf_tgt -c /path/to/nvmf.conf</div></div><!-- fragment --><h3><a class="anchor" id="nvmf_config_subsystem"></a>
Subsystem Configuration</h3>
<p>The <code>[Subsystem]</code> section in the configuration file is used to configure subysystems for the NVMe-oF target.</p>
<p>This example shows two local PCIe NVMe devices exposed as separate NVMe-oF target subsystems:</p>
<div class="fragment"><div class="line">[Nvme]</div><div class="line">TransportID &quot;trtype:PCIe traddr:0000:02:00.0&quot; Nvme0</div><div class="line">TransportID &quot;trtype:PCIe traddr:0000:82:00.0&quot; Nvme1</div><div class="line"></div><div class="line">[Subsystem1]</div><div class="line">NQN nqn.2016-06.io.spdk:cnode1</div><div class="line">Listen RDMA 192.168.100.8:4420</div><div class="line">AllowAnyHost No</div><div class="line">Host nqn.2016-06.io.spdk:init</div><div class="line">SN SPDK00000000000001</div><div class="line">Namespace Nvme0n1 1</div><div class="line"></div><div class="line">[Subsystem2]</div><div class="line">NQN nqn.2016-06.io.spdk:cnode2</div><div class="line">Listen RDMA 192.168.100.9:4420</div><div class="line">AllowAnyHost Yes</div><div class="line">SN SPDK00000000000002</div><div class="line">Namespace Nvme1n1 1</div></div><!-- fragment --><p>Any bdev may be presented as a namespace. See <a class="el" href="bdev.html">Block Device Layer</a> for details on setting up bdevs. For example, to create a virtual controller with two namespaces backed by the malloc bdevs named Malloc0 and Malloc1 and made available as NSID 1 and 2: </p><div class="fragment"><div class="line">[Subsystem3]</div><div class="line">  NQN nqn.2016-06.io.spdk:cnode3</div><div class="line">  Listen RDMA 192.168.2.21:4420</div><div class="line">  AllowAnyHost Yes</div><div class="line">  SN SPDK00000000000003</div><div class="line">  Namespace Malloc0 1</div><div class="line">  Namespace Malloc1 2</div></div><!-- fragment --><h3><a class="anchor" id="nvmf_config_lcore"></a>
Assigning CPU Cores to the NVMe over Fabrics Target</h3>
<p>SPDK uses the <a href="http://dpdk.org/doc/guides/prog_guide/env_abstraction_layer.html">DPDK Environment Abstraction Layer</a> to gain access to hardware resources such as huge memory pages and CPU core(s). DPDK EAL provides functions to assign threads to specific cores. To ensure the SPDK NVMe-oF target has the best performance, configure the RNICs and NVMe devices to be located on the same NUMA node.</p>
<p>The <code>-m</code> core mask option specifies a bit mask of the CPU cores that SPDK is allowed to execute work items on. For example, to allow SPDK to use cores 24, 25, 26 and 27: </p><div class="fragment"><div class="line">app/nvmf_tgt/nvmf_tgt -m 0xF000000</div></div><!-- fragment --><h2><a class="anchor" id="nvmf_host"></a>
Configuring the Linux NVMe over Fabrics Host</h2>
<p>Both the Linux kernel and SPDK implement an NVMe over Fabrics host. The Linux kernel NVMe-oF RDMA host support is provided by the <code>nvme-rdma</code> driver.</p>
<div class="fragment"><div class="line">modprobe nvme-rdma</div></div><!-- fragment --><p>The nvme-cli tool may be used to interface with the Linux kernel NVMe over Fabrics host.</p>
<p>Discovery: </p><div class="fragment"><div class="line">nvme discover -t rdma -a 192.168.100.8 -s 4420</div></div><!-- fragment --><p>Connect: </p><div class="fragment"><div class="line">nvme connect -t rdma -n &quot;nqn.2016-06.io.spdk:cnode1&quot; -a 192.168.100.8 -s 4420</div></div><!-- fragment --><p>Disconnect: </p><div class="fragment"><div class="line">nvme disconnect -n &quot;nqn.2016-06.io.spdk:cnode1&quot;</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
</div>
