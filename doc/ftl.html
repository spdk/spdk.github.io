<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Doxygen 1.10.0" />
	<title>SPDK: Flash Translation Layer</title>
	<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js" integrity="sha512-TPh2Oxlg1zp+kz3nFA0C5vVC6leG/6mm1z9+mA81MI5eaUVqasPLO8Cuk4gMF4gUfP5etR73rgU/8PNMsSesoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
	<script type="text/javascript" src="../js/doxyboot.js"></script>
	<script type="text/javascript">
		$( document ).ready(function() {
			$("#cn_lang_btn").remove();
		});
	</script>
	<script type="text/javascript" src="./navtree.js"></script>
	<link rel="stylesheet" href='https://fonts.googleapis.com/css?family=Roboto:400,900' type='text/css'>
	<link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="../css/spdk.css" rel="stylesheet" type="text/css">
</head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark px-2">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="/" aria-label="SPDK">
    <img src="../img/spdk.svg"  width="36" height="36" alt="Storage Performance Development Kit" />
  </a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav me-auto">
      <a class="nav-link header-link"
      href="../releases/">
        download
      </a>
      <a class="nav-link header-link active text-white"
      href="/doc/">
        documentation
      </a>
      <a class="nav-link header-link"
      href="../development/">
        development
      </a>
      <a class="nav-link header-link"
      href="/ci/">
        CI status
      </a>
      <a class="nav-link header-link"
      href="../community/">
        community
      </a>
      <a class="nav-link header-link"
      href="../blog/">
        Blog
      </a>
      <a class="nav-link header-link"
      href="https://github.com/orgs/spdk/projects/5">
        Roadmap
      </a>
      <a class="nav-link header-link"
      href="../news/">
        News
      </a>
    </div>
    <div class="navbar-nav ms-auto me-3">
      <a class="nav-link header-link" href="https://github.com/spdk/spdk">
        <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
      </a>
      <a id="cn_lang_btn" href="/cn/doc/" class="nav-link header-link">中文</a>
    </div>
  </div>
</nav>
  <div class="container-fluid doc">
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('ftl.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Flash Translation Layer</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_ftl"></a> The Flash Translation Layer library provides efficient 4K block device access on top of devices with &gt;4K write unit size (eg. raid5f bdev) or devices with large indirection units (some capacity-focused NAND drives), which don't handle 4K writes well. It handles the logical to physical address mapping and manages the garbage collection process.</p>
<h1><a class="anchor" id="ftl_terminology"></a>
Terminology</h1>
<h2><a class="anchor" id="ftl_l2p"></a>
Logical to physical address map</h2>
<ul>
<li>Shorthand: <code>L2P</code></li>
</ul>
<p>Contains the mapping of the logical addresses (LBA) to their on-disk physical location. The LBAs are contiguous and in range from 0 to the number of surfaced blocks (the number of spare blocks are calculated during device formation and are subtracted from the available address space). The spare blocks account for zones going offline throughout the lifespan of the device as well as provide necessary buffer for data <a class="el" href="#ftl_reloc">garbage collection</a>.</p>
<p>Since the L2P would occupy a significant amount of DRAM (4B/LBA for drives smaller than 16TiB, 8B/LBA for bigger drives), FTL will, by default, store only the 2GiB of most recently used L2P addresses in memory (the amount is configurable), and page them in and out of the cache device as necessary.</p>
<h2><a class="anchor" id="ftl_band"></a>
Band</h2>
<p>A band describes a collection of zones, each belonging to a different parallel unit. All writes to a band follow the same pattern - a batch of logical blocks is written to one zone, another batch to the next one and so on. This ensures the parallelism of the write operations, as they can be executed independently on different zones. Each band keeps track of the LBAs it consists of, as well as their validity, as some of the data will be invalidated by subsequent writes to the same logical address. The L2P mapping can be restored from the SSD by reading this information in order from the oldest band to the youngest.</p>
<div class="fragment"><div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">band 1   |   zone 1     +--------+    zone 1    +---- --- --- --- --- ---+     zone 1   |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">band 2   |   zone 2     +--------+     zone 2   +---- --- --- --- --- ---+     zone 2   |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">band 3   |   zone 3     +--------+     zone 3   +---- --- --- --- --- ---+     zone 3   |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">         |     ...      |        |     ...      |                        |     ...      |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">band m   |   zone m     +--------+     zone m   +---- --- --- --- --- ---+     zone m   |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line">         |     ...      |        |     ...      |                        |     ...      |</div>
<div class="line">         +--------------+        +--------------+                        +--------------+</div>
<div class="line"> </div>
<div class="line">          parallel unit 1              pu 2                                    pu n</div>
</div><!-- fragment --><p>The address map (<code>P2L</code>) is saved as a part of the band's metadata, at the end of each band:</p>
<div class="fragment"><div class="line">                    band&#39;s data                        tail metadata</div>
<div class="line">+-------------------+-------------------------------+------------------------+</div>
<div class="line">|zone 1 |...|zone n |...|...|zone 1 |...|           | ... |zone  m-1 |zone  m|</div>
<div class="line">|block 1|   |block 1|   |   |block x|   |           |     |block y   |block y|</div>
<div class="line">+-------------------+-------------+-----------------+------------------------+</div>
</div><!-- fragment --><p>Bands are written sequentially (in a way that was described earlier). Before a band can be written to, all of its zones need to be erased. During that time, the band is considered to be in a <code>PREP</code> state. Then the band moves to the <code>OPEN</code> state and actual user data can be written to the band. Once the whole available space is filled, tail metadata is written and the band transitions to <code>CLOSING</code> state. When that finishes the band becomes <code>CLOSED</code>.</p>
<h2><a class="anchor" id="ftl_nvcache"></a>
Non volatile cache</h2>
<ul>
<li>Shorthand: <code>nvcache</code></li>
</ul>
<p>Nvcache is a bdev that is used for buffering user writes and storing various metadata. Nvcache data space is divided into chunks. Chunks are written in sequential manner. When number of free chunks is below assigned threshold data from fully written chunks is moved to base_bdev. This process is called chunk compaction. </p><div class="fragment"><div class="line">                  nvcache</div>
<div class="line">+-----------------------------------------+</div>
<div class="line">|chunk 1                                  |</div>
<div class="line">|   +--------------------------------- +  |</div>
<div class="line">|   |blk 1 + md| blk 2 + md| blk n + md|  |</div>
<div class="line">|   +----------------------------------|  |</div>
<div class="line">+-----------------------------------------+</div>
<div class="line">| ...                                     |</div>
<div class="line">+-----------------------------------------+</div>
<div class="line">+-----------------------------------------+</div>
<div class="line">|chunk N                                  |</div>
<div class="line">|   +--------------------------------- +  |</div>
<div class="line">|   |blk 1 + md| blk 2 + md| blk n + md|  |</div>
<div class="line">|   +----------------------------------|  |</div>
<div class="line">+-----------------------------------------+</div>
</div><!-- fragment --><h2><a class="anchor" id="ftl_reloc"></a>
Garbage collection and relocation</h2>
<ul>
<li>Shorthand: gc, reloc</li>
</ul>
<p>Since a write to the same LBA invalidates its previous physical location, some of the blocks on a band might contain old data that basically wastes space. As there is no way to overwrite an already written block for a ZNS drive, this data will stay there until the whole zone is reset. This might create a situation in which all of the bands contain some valid data and no band can be erased, so no writes can be executed anymore. Therefore a mechanism is needed to move valid data and invalidate whole bands, so that they can be reused.</p>
<div class="fragment"><div class="line">                band                                             band</div>
<div class="line">+-----------------------------------+            +-----------------------------------+</div>
<div class="line">| ** *    * ***      *    *** * *   |            |                                   |</div>
<div class="line">|**  *       *    *    * *     *   *|   +----&gt;   |                                   |</div>
<div class="line">|*     ***  *      *            *   |            |                                   |</div>
<div class="line">+-----------------------------------+            +-----------------------------------+</div>
</div><!-- fragment --><p>Valid blocks are marked with an asterisk '*'.</p>
<p>Module responsible for data relocation is called <code>reloc</code>. When a band is chosen for garbage collection, the appropriate blocks are marked as required to be moved. The <code>reloc</code> module takes a band that has some of such blocks marked, checks their validity and, if they're still valid, copies them.</p>
<p>Choosing a band for garbage collection depends its validity ratio (proportion of valid blocks to all user blocks). The lower the ratio, the higher the chance the band will be chosen for gc.</p>
<h1><a class="anchor" id="ftl_metadata"></a>
Metadata</h1>
<p>In addition to the <a class="el" href="#ftl_l2p">L2P</a>, FTL will store additional metadata both on the cache, as well as on the base devices. The following types of metadata are persisted:</p>
<ul>
<li>Superblock - stores the global state of FTL; stored on cache, mirrored to the base device</li>
<li>L2P - see the <a class="el" href="#ftl_l2p">L2P</a> section for details</li>
<li>Band - stores the state of bands - write pointers, their OPEN/FREE/CLOSE state; stored on cache, mirrored to a different section of the cache device</li>
<li>Valid map - bitmask of all the valid physical addresses, used for improving <a class="el" href="#ftl_reloc">relocation</a></li>
<li>Chunk - stores the state of chunks - write pointers, their OPEN/FREE/CLOSE state; stored on cache, mirrored to a different section of the cache device</li>
<li>P2L - stores the address mapping (P2L, see <a class="el" href="#ftl_band">band</a>) of currently open bands. This allows for the recovery of open bands after dirty shutdown without needing VSS DIX metadata on the base device; stored on the cache device</li>
<li>Trim - stores information about unmapped (trimmed) LBAs; stored on cache, mirrored to a different section of the cache device</li>
</ul>
<h1><a class="anchor" id="ftl_dirty_shutdown"></a>
Dirty shutdown recovery</h1>
<p>After power failure, FTL needs to rebuild the whole L2P using the address maps (<code>P2L</code>) stored within each band/chunk. This needs to done, because while individual L2P pages may have been paged out and persisted to the cache device, there's no way to tell which, if any, pages were dirty before the power failure occurred. The P2L consists of not only the mapping itself, but also a sequence id (<code>seq_id</code>), which describes the relative age of a given logical block (multiple writes to the same logical block would produce the same amount of P2L entries, only the last one having the current data).</p>
<p>FTL will therefore rebuild the whole L2P by reading the P2L of all closed bands and chunks. For open bands, the P2L is stored on the cache device, in a separate metadata region (see <a class="el" href="#ftl_metadata">the P2L section</a>). Open chunks can be restored thanks to storing the mapping in the VSS DIX metadata, which the cache device must be formatted with.</p>
<h2><a class="anchor" id="ftl_shm_recovery"></a>
Shared memory recovery</h2>
<p>In order to shorten the recovery after crash of the target application, FTL also stores its metadata in shared memory (<code>shm</code>) - this allows it to keep track of the dirty-ness state of individual pages and shortens the recovery time dramatically, as FTL will only need to mark any potential L2P pages which were paging out at the time of the crash as dirty and reissue the writes. There's no need to read the whole P2L in this case.</p>
<h2><a class="anchor" id="ftl_trim"></a>
Trim</h2>
<p>Due to metadata size constraints and the difficulty of maintaining consistent data returned before and after dirty shutdown, FTL currently only allows for trims (unmaps) aligned to 4MiB (alignment concerns both the offset and length of the trim command).</p>
<h1><a class="anchor" id="ftl_usage"></a>
Usage</h1>
<h2><a class="anchor" id="ftl_prereq"></a>
Prerequisites</h2>
<p>In order to use the FTL module, a cache device formatted with VSS DIX metadata is required.</p>
<h2><a class="anchor" id="ftl_create"></a>
FTL bdev creation</h2>
<p>Similar to other bdevs, the FTL bdevs can be created either based on JSON config files or via RPC. Both interfaces require the same arguments which are described by the <code>--help</code> option of the <code>bdev_ftl_create</code> RPC call, which are:</p>
<ul>
<li>bdev's name</li>
<li>base bdev's name</li>
<li>cache bdev's name (cache bdev must support VSS DIX mode)</li>
<li>UUID of the FTL device (if the FTL is to be restored from the SSD)</li>
</ul>
<h1><a class="anchor" id="ftl_bdev_stack"></a>
FTL bdev stack</h1>
<p>In order to create FTL on top of a regular bdev: 1) Create regular bdev e.g. <code>bdev_nvme</code>, <code>bdev_null</code>, <code>bdev_malloc</code> 2) Create second regular bdev for nvcache 3) Create FTL bdev on top of bdev created in step 1 and step 2</p>
<p>Example: </p><div class="fragment"><div class="line">$ scripts/rpc.py bdev_nvme_attach_controller -b nvme0 -a 00:05.0 -t pcie</div>
<div class="line">        nvme0n1</div>
<div class="line"> </div>
<div class="line">$ scripts/rpc.py bdev_nvme_attach_controller -b nvme1 -a 00:06.0 -t pcie</div>
<div class="line">        nvme1n1</div>
<div class="line"> </div>
<div class="line">$ scripts/rpc.py bdev_ftl_create -b ftl0 -d nvme0n1 -c nvme1n1</div>
<div class="line">{</div>
<div class="line">        &quot;name&quot;: &quot;ftl0&quot;,</div>
<div class="line">        &quot;uuid&quot;: &quot;3b469565-1fa5-4bfb-8341-747ec9f3a9b9&quot;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
<ul>
        <li class="footer">Generated by
        <a href="http://www.doxygen.org/index.html">doxygen</a> 1.10.0 </li>
</ul>
</div>
</div>
</body>
</html>
