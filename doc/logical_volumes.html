<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Doxygen 1.10.0" />
  <title>SPDK: Logical Volumes</title>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="../js/doxyboot.js"></script>
  <script type="text/javascript" src="./navtree.js"></script>
  <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../css/spdk.css" rel="stylesheet" type="text/css">
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark px-2">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/" aria-label="SPDK">
      <img src="/img/spdk.svg"  width="36" height="36" alt="Storage Performance Development Kit" />
    </a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <div class="navbar-nav me-auto">
        <a class="nav-link header-link active" href="../doc/">Documentation</a>
        <a class="nav-link header-link" href="../development/">Development</a>
        <a class="nav-link header-link" href="../community/">Community</a>
        <a class="nav-link header-link" href="../blog/">Blog</a>
      </div>
      <div class="navbar-nav ms-auto me-3">
        <a class="nav-link header-link" href="https://github.com/spdk/spdk">
          <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      </div>
    </div>
  </nav>
  <div class="container-fluid doc">
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('logical_volumes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Logical Volumes</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_lvol"></a> The Logical Volumes library is a flexible storage space management system. It provides creating and managing virtual block devices with variable size. The SPDK Logical Volume library is built on top of <a class="el" href="blob.html">Blobstore Programmer's Guide</a>.</p>
<h1><a class="anchor" id="lvol_terminology"></a>
Terminology</h1>
<h2><a class="anchor" id="lvs"></a>
Logical volume store</h2>
<ul>
<li>Shorthand: lvolstore, lvs</li>
<li>Type name: struct spdk_lvol_store</li>
</ul>
<p>A logical volume store uses the super blob feature of blobstore to hold uuid (and in future other metadata). Blobstore types are implemented in blobstore itself, and saved on disk. An lvolstore will generate a UUID on creation, so that it can be uniquely identified from other lvolstores. By default when creating lvol store data region is unmapped. Optional &ndash;clear-method parameter can be passed on creation to change that behavior to writing zeroes or performing no operation.</p>
<h2><a class="anchor" id="lvol"></a>
Logical volume</h2>
<ul>
<li>Shorthand: lvol</li>
<li>Type name: struct spdk_lvol</li>
</ul>
<p>A logical volume is implemented as an SPDK blob created from an lvolstore. An lvol is uniquely identified by its UUID. Lvol additional can have alias name.</p>
<h2><a class="anchor" id="lvol_bdev"></a>
Logical volume block device</h2>
<ul>
<li>Shorthand: lvol_bdev</li>
<li>Type name: struct spdk_lvol_bdev</li>
</ul>
<p>Representation of an SPDK block device (<a class="el" href="structspdk__bdev.html">spdk_bdev</a>) with an lvol implementation. A logical volume block device translates generic SPDK block device I/O (<a class="el" href="structspdk__bdev__io.html">spdk_bdev_io</a>) operations into the equivalent SPDK blob operations. Combination of lvol name and lvolstore name gives lvol_bdev alias name in a form "lvs_name/lvol_name". block_size of the created bdev is always 4096, due to blobstore page size. Cluster_size is configurable by parameter. Size of the new bdev will be rounded up to nearest multiple of cluster_size. By default lvol bdevs claim part of lvol store equal to their set size. When thin provision option is enabled, no space is taken from lvol store until data is written to lvol bdev. By default when deleting lvol bdev or resizing down, allocated clusters are unmapped. Optional &ndash;clear-method parameter can be passed on creation to change that behavior to writing zeroes or performing no operation.</p>
<h2><a class="anchor" id="lvol_thin_provisioning"></a>
Thin provisioning</h2>
<p>Thin provisioned lvols rely on dynamic cluster allocation (e.g. when the first write operation on a cluster is performed), only space required to store data is used and unallocated clusters are obtained from underlying device (e.g. zeroes_dev).</p>
<p>Sample write operations of thin provisioned blob are shown on the diagram below:</p>
<div class="image">
<object type="image/svg+xml" data="lvol_thin_provisioning_write.svg" style="pointer-events: none;"></object>
<div class="caption">
Writing clusters to the thin provisioned blob</div></div>
    <p>Sample read operations and the structure of thin provisioned blob are shown on the diagram below:</p>
<div class="image">
<object type="image/svg+xml" data="lvol_thin_provisioning.svg" style="pointer-events: none;"></object>
<div class="caption">
Reading clusters from thin provisioned blob</div></div>
    <h2><a class="anchor" id="lvol_snapshots"></a>
Snapshots and clone</h2>
<p>Logical volumes support snapshots and clones functionality. User may at any given time create snapshot of existing logical volume to save a backup of current volume state. When creating snapshot original volume becomes thin provisioned and saves only incremental differences from its underlying snapshot. This means that every read from unallocated cluster is actually a read from the snapshot and every write to unallocated cluster triggers new cluster allocation and data copy from corresponding cluster in snapshot to the new cluster in logical volume before the actual write occurs.</p>
<p>The read operation is performed as shown in the diagram below: <img src="lvol_clone_snapshot_read.svg" alt="" style="pointer-events: none;" class="inline" title="Reading cluster from clone"/>    </p>
<p>The write operation is performed as shown in the diagram below: <img src="lvol_clone_snapshot_write.svg" alt="" style="pointer-events: none;" class="inline" title="Writing cluster to the clone"/>    </p>
<p>User may also create clone of existing snapshot that will be thin provisioned and it will behave in the same way as logical volume from which snapshot is created. There is no limit of clones and snapshots that may be created as long as there is enough space on logical volume store. Snapshots are read only. Clones may be created only from snapshots or read only logical volumes.</p>
<p>A snapshot can be removed only if there is a single clone on top of it. The relation chain will be updated accordingly. The cluster map of clone and snapshot will be merged and entries for unallocated clusters in the clone will be updated with addresses from the snapshot cluster map. The entire operation modifies metadata only - no data is copied during this process.</p>
<h2>External Snapshots</h2>
<p>With the external snapshots feature, clones can be made of any bdev. These clones are commonly called <em>esnap clones</em>. Esnap clones work very similarly to thin provisioning. Rather than the back device being an zeroes device, the external snapshot bdev is used as the back device.</p>
<div class="image">
<object type="image/svg+xml" data="lvol_esnap_clone.svg" style="pointer-events: none;"></object>
<div class="caption">
Clone of External Snapshot</div></div>
    <p>A bdev that is used as an external snapshot cannot be opened for writing by anything else so long as an esnap clone exists.</p>
<p>A bdev may have multiple esnap clones and esnap clones can themselves be snapshotted and cloned.</p>
<h2><a class="anchor" id="lvol_inflation"></a>
Inflation</h2>
<p>Blobs can be inflated to copy data from backing devices (e.g. snapshots) and allocate all remaining clusters. As a result of this operation all dependencies for the blob are removed.</p>
<div class="image">
<object type="image/svg+xml" data="lvol_inflate_clone_snapshot.svg" style="pointer-events: none;"></object>
<div class="caption">
Removing backing blob and bdevs relations using inflate call</div></div>
    <h2><a class="anchor" id="lvol_decoupling"></a>
Decoupling</h2>
<p>Blobs can be decoupled from their parent blob by copying data from backing devices (e.g. snapshots) for all allocated clusters. Remaining unallocated clusters are kept thin provisioned. Note: When decouple is performed, only single dependency is removed. To remove all dependencies in a chain of blobs depending on each other, multiple calls need to be issued.</p>
<h1>Configuring Logical Volumes</h1>
<p>There is no static configuration available for logical volumes. All configuration is done trough RPC. Information about logical volumes is kept on block devices.</p>
<h1><a class="anchor" id="lvol_rpc"></a>
RPC overview</h1>
<p>RPC regarding lvolstore:</p>
<div class="fragment"><div class="line">bdev_lvol_create_lvstore [-h] [-c CLUSTER_SZ] bdev_name lvs_name</div>
<div class="line">    Constructs lvolstore on specified bdev with specified name. During</div>
<div class="line">    construction bdev is unmapped at initialization and all data is</div>
<div class="line">    erased. Then original bdev is claimed by</div>
<div class="line">    SPDK, but no additional spdk bdevs are created.</div>
<div class="line">    Returns uuid of created lvolstore.</div>
<div class="line">    Optional parameters:</div>
<div class="line">    -h  show help</div>
<div class="line">    -c  CLUSTER_SZ Specifies the size of cluster. By default its 4MiB.</div>
<div class="line">    --clear-method specify data region clear method &quot;none&quot;, &quot;unmap&quot; (default), &quot;write_zeroes&quot;</div>
<div class="line">bdev_lvol_delete_lvstore [-h] [-u UUID] [-l LVS_NAME]</div>
<div class="line">    Destroy lvolstore on specified bdev. Removes lvolstore along with lvols on</div>
<div class="line">    it. User can identify lvol store by UUID or its name. Note that destroying</div>
<div class="line">    lvolstore requires using this call, while deleting single lvol requires</div>
<div class="line">    using bdev_lvol_delete rpc call.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_get_lvstores [-h] [-u UUID] [-l LVS_NAME]</div>
<div class="line">    Display current logical volume store list</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">    -u UUID, --uuid UUID  show details of specified lvol store</div>
<div class="line">    -l LVS_NAME, --lvs_name LVS_NAME  show details of specified lvol store</div>
<div class="line">bdev_lvol_rename_lvstore [-h] old_name new_name</div>
<div class="line">    Change logical volume store name</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show this help message and exit</div>
</div><!-- fragment --><p>RPC regarding lvol and spdk bdev:</p>
<div class="fragment"><div class="line">bdev_lvol_create [-h] [-u UUID] [-l LVS_NAME] [-t] [-c CLEAR_METHOD] lvol_name size</div>
<div class="line">    Creates lvol with specified size and name on lvolstore specified by its uuid</div>
<div class="line">    or name. Then constructs spdk bdev on top of that lvol and presents it as spdk bdev.</div>
<div class="line">    User may use -t switch to create thin provisioned lvol.</div>
<div class="line">    Returns the name of new spdk bdev</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">    -c, --clear-method specify data clusters clear method &quot;none&quot;, &quot;unmap&quot; (default), &quot;write_zeroes&quot;</div>
<div class="line">bdev_lvol_get_lvols [-h] [-u LVS_UUID] [-l LVS_NAME]</div>
<div class="line">    Display logical volume list, including those that do not have associated bdevs.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">    -u LVS_UUID, --lvs_uuid UUID  show volumes only in the specified lvol store</div>
<div class="line">    -l LVS_NAME, --lvs_name LVS_NAME  show volumes only in the specified lvol store</div>
<div class="line">bdev_get_bdevs [-h] [-b NAME]</div>
<div class="line">    User can view created bdevs using this call including those created on top of lvols.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">    -b NAME, --name NAME  Name of the block device. Example: Nvme0n1</div>
<div class="line">bdev_lvol_delete [-h] bdev_name</div>
<div class="line">    Deletes a logical volume previously created by bdev_lvol_create.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_snapshot [-h] lvol_name snapshot_name</div>
<div class="line">    Create a snapshot with snapshot_name of a given lvol bdev.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_clone [-h] snapshot_name clone_name</div>
<div class="line">    Create a clone with clone_name of a given lvol snapshot.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_clone_bdev [-h] bdev_name_or_uuid lvs_name clone_name</div>
<div class="line">    Create a clone with clone_name of a bdev. The bdev must not be an lvol in the lvs_name lvstore.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_rename [-h] old_name new_name</div>
<div class="line">    Change lvol bdev name</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_resize [-h] name size</div>
<div class="line">    Resize existing lvol bdev</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_set_read_only [-h] name</div>
<div class="line">    Mark lvol bdev as read only</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_inflate [-h] name</div>
<div class="line">    Inflate lvol bdev</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_decouple_parent [-h] name</div>
<div class="line">    Decouple parent of a logical volume</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_start_shallow_copy [-h] src_lvol_name dst_bdev_name</div>
<div class="line">    Make a shallow copy of lvol over a given bdev</div>
<div class="line">    This RPC starts the operation and returns an identifier that can be used to query the status</div>
<div class="line">    of the operation with the RPC bdev_lvol_check_shallow_copy.</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_check_shallow_copy [-h] operation_id</div>
<div class="line">    Get shallow copy status</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_set_parent [-h] lvol_name snapshot_name</div>
<div class="line">    Set the parent snapshot of a lvol</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
<div class="line">bdev_lvol_set_parent_bdev lvol_name esnap_name</div>
<div class="line">    Set the parent external snapshot of a lvol</div>
<div class="line">    optional arguments:</div>
<div class="line">    -h, --help  show help</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
<ul>
        <li class="footer">Generated by
        <a href="http://www.doxygen.org/index.html">doxygen</a> 1.10.0 </li>
</ul>
</div>
</div>
</body>
</html>
