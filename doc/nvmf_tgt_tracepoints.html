<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.13">
  <title>SPDK: NVMe-oF Target Tracepoints</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-xs-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://spdk.io/ci/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('nvmf_tgt_tracepoints.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">NVMe-oF Target Tracepoints </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="tracepoints_intro"></a>
Introduction</h1>
<p>SPDK has a tracing framework for capturing low-level event information at runtime. Tracepoints provide a high-performance tracing mechanism that is accessible at runtime. They are implemented as a circular buffer in shared memory that is accessible from other processes. The NVMe-oF target is instrumented with tracepoints to enable analysis of both performance and application crashes. (Note: the SPDK tracing framework should still be considered experimental. Work to formalize and document the framework is in progress.)</p>
<h1><a class="anchor" id="enable_tracepoints"></a>
Enabling Tracepoints</h1>
<p>Tracepoints are placed in groups. They are enabled and disabled as a group. To enable the instrumentation of all the tracepoints group in an SPDK target application, start the target with -e parameter set to 0xFFFF:</p>
<div class="fragment"><div class="line">app/nvmf_tgt/nvmf_tgt -e 0xFFFF</div></div><!-- fragment --><p>To enable the instrumentation of just the NVMe-oF RDMA tracepoints in an SPDK target application, start the target with the -e parameter set to 0x10:</p>
<div class="fragment"><div class="line">app/nvmf_tgt/nvmf_tgt -e 0x10</div></div><!-- fragment --><p>When the target starts, a message is logged with the information you need to view the tracepoints in a human-readable format using the spdk_trace application. The target will also log information about the shared memory file.</p>
<div class="fragment"><div class="line">app.c: 527:spdk_app_setup_trace: *NOTICE*: Tracepoint Group Mask 0xFFFF specified.</div><div class="line">app.c: 531:spdk_app_setup_trace: *NOTICE*: Use &#39;spdk_trace -s nvmf -p 24147&#39; to capture a snapshot of events at runtime.</div><div class="line">app.c: 533:spdk_app_setup_trace: *NOTICE*: Or copy /dev/shm/nvmf_trace.pid24147 for offline analysis/debug.</div></div><!-- fragment --><p>Note that when tracepoints are enabled, the shared memory files are not deleted when the application exits. This ensures the file can be used for analysis after the application exits. On Linux, the shared memory files are in /dev/shm, and can be deleted manually to free shm space if needed. A system reboot will also free all of the /dev/shm files.</p>
<h1><a class="anchor" id="capture_tracepoints"></a>
Capturing a snapshot of events</h1>
<p>Send I/Os to the SPDK target application to generate events. The following is an example usage of perf to send I/Os to the NVMe-oF target over an RDMA network interface for 10 minutes.</p>
<div class="fragment"><div class="line">./perf -q 128 -s 4096 -w randread -t 600 -r &#39;trtype:RDMA adrfam:IPv4 traddr:192.168.100.2 trsvcid:4420&#39;</div></div><!-- fragment --><p>The spdk_trace program can be found in the app/trace directory. To analyze the tracepoints on the same system running the NVMe-oF target, simply execute the command line shown in the log:</p>
<div class="fragment"><div class="line">app/trace/spdk_trace -s nvmf -p 24147</div></div><!-- fragment --><p>To analyze the tracepoints on a different system, first prepare the tracepoint file for transfer. The tracepoint file can be large, but usually compresses very well. This step can also be used to prepare a tracepoint file to attach to a GitHub issue for debugging NVMe-oF application crashes.</p>
<div class="fragment"><div class="line">bzip2 -c /dev/shm/nvmf_trace.pid24147 &gt; /tmp/trace.bz2</div></div><!-- fragment --><p>After transferring the /tmp/trace.bz2 tracepoint file to a different system:</p>
<div class="fragment"><div class="line">bunzip2 /tmp/trace.bz2</div><div class="line">app/trace/spdk_trace -f /tmp/trace</div></div><!-- fragment --><p>The following is sample trace capture showing the cumulative time that each I/O spends at each RDMA state. All the trace captures with the same id are for the same I/O.</p>
<div class="fragment"><div class="line">28:   6026.658 ( 12656064)     RDMA_REQ_NEED_BUFFER                                      id:    r3622            time:  0.019</div><div class="line">28:   6026.694 ( 12656140)     RDMA_REQ_RDY_TO_EXECUTE                                   id:    r3622            time:  0.055</div><div class="line">28:   6026.820 ( 12656406)     RDMA_REQ_EXECUTING                                        id:    r3622            time:  0.182</div><div class="line">28:   6026.992 ( 12656766)     RDMA_REQ_EXECUTED                                         id:    r3477            time:  228.510</div><div class="line">28:   6027.010 ( 12656804)     RDMA_REQ_TX_PENDING_C_TO_H                                id:    r3477            time:  228.528</div><div class="line">28:   6027.022 ( 12656828)     RDMA_REQ_RDY_TO_COMPLETE                                  id:    r3477            time:  228.539</div><div class="line">28:   6027.115 ( 12657024)     RDMA_REQ_COMPLETING                                       id:    r3477            time:  228.633</div><div class="line">28:   6027.471 ( 12657770)     RDMA_REQ_COMPLETED                                        id:    r3518            time:  171.577</div><div class="line">28:   6028.027 ( 12658940)     RDMA_REQ_NEW                                              id:    r3623</div><div class="line">28:   6028.057 ( 12659002)     RDMA_REQ_NEED_BUFFER                                      id:    r3623            time:  0.030</div><div class="line">28:   6028.095 ( 12659082)     RDMA_REQ_RDY_TO_EXECUTE                                   id:    r3623            time:  0.068</div><div class="line">28:   6028.216 ( 12659336)     RDMA_REQ_EXECUTING                                        id:    r3623            time:  0.189</div><div class="line">28:   6028.408 ( 12659740)     RDMA_REQ_EXECUTED                                         id:    r3505            time:  190.509</div><div class="line">28:   6028.441 ( 12659808)     RDMA_REQ_TX_PENDING_C_TO_H                                id:    r3505            time:  190.542</div><div class="line">28:   6028.452 ( 12659832)     RDMA_REQ_RDY_TO_COMPLETE                                  id:    r3505            time:  190.553</div><div class="line">28:   6028.536 ( 12660008)     RDMA_REQ_COMPLETING                                       id:    r3505            time:  190.637</div><div class="line">28:   6028.854 ( 12660676)     RDMA_REQ_COMPLETED                                        id:    r3465            time:  247.000</div><div class="line">28:   6029.433 ( 12661892)     RDMA_REQ_NEW                                              id:    r3624</div><div class="line">28:   6029.452 ( 12661932)     RDMA_REQ_NEED_BUFFER                                      id:    r3624            time:  0.019</div><div class="line">28:   6029.482 ( 12661996)     RDMA_REQ_RDY_TO_EXECUTE                                   id:    r3624            time:  0.050</div><div class="line">28:   6029.591 ( 12662224)     RDMA_REQ_EXECUTING                                        id:    r3624            time:  0.158</div><div class="line">28:   6029.782 ( 12662624)     RDMA_REQ_EXECUTED                                         id:    r3564            time:  96.937</div><div class="line">28:   6029.798 ( 12662658)     RDMA_REQ_TX_PENDING_C_TO_H                                id:    r3564            time:  96.953</div><div class="line">28:   6029.812 ( 12662688)     RDMA_REQ_RDY_TO_COMPLETE                                  id:    r3564            time:  96.967</div><div class="line">28:   6029.899 ( 12662870)     RDMA_REQ_COMPLETING                                       id:    r3564            time:  97.054</div><div class="line">28:   6030.262 ( 12663634)     RDMA_REQ_COMPLETED                                        id:    r3477            time:  231.780</div><div class="line">28:   6030.786 ( 12664734)     RDMA_REQ_NEW                                              id:    r3625</div><div class="line">28:   6030.804 ( 12664772)     RDMA_REQ_NEED_BUFFER                                      id:    r3625            time:  0.018</div><div class="line">28:   6030.841 ( 12664848)     RDMA_REQ_RDY_TO_EXECUTE                                   id:    r3625            time:  0.054</div><div class="line">28:   6030.963 ( 12665104)     RDMA_REQ_EXECUTING                                        id:    r3625            time:  0.176</div><div class="line">28:   6031.139 ( 12665474)     RDMA_REQ_EXECUTED                                         id:    r3552            time:  114.906</div><div class="line">28:   6031.196 ( 12665594)     RDMA_REQ_TX_PENDING_C_TO_H                                id:    r3552            time:  114.963</div><div class="line">28:   6031.210 ( 12665624)     RDMA_REQ_RDY_TO_COMPLETE                                  id:    r3552            time:  114.977</div><div class="line">28:   6031.293 ( 12665798)     RDMA_REQ_COMPLETING                                       id:    r3552            time:  115.060</div><div class="line">28:   6031.633 ( 12666512)     RDMA_REQ_COMPLETED                                        id:    r3505            time:  193.734</div><div class="line">28:   6032.230 ( 12667766)     RDMA_REQ_NEW                                              id:    r3626</div><div class="line">28:   6032.248 ( 12667804)     RDMA_REQ_NEED_BUFFER                                      id:    r3626            time:  0.018</div><div class="line">28:   6032.288 ( 12667888)     RDMA_REQ_RDY_TO_EXECUTE                                   id:    r3626            time:  0.058</div><div class="line">28:   6032.396 ( 12668114)     RDMA_REQ_EXECUTING                                        id:    r3626            time:  0.166</div><div class="line">28:   6032.593 ( 12668528)     RDMA_REQ_EXECUTED                                         id:    r3570            time:  90.443</div><div class="line">28:   6032.611 ( 12668564)     RDMA_REQ_TX_PENDING_C_TO_H                                id:    r3570            time:  90.460</div><div class="line">28:   6032.623 ( 12668590)     RDMA_REQ_RDY_TO_COMPLETE                                  id:    r3570            time:  90.473</div><div class="line">28:   6032.707 ( 12668766)     RDMA_REQ_COMPLETING                                       id:    r3570            time:  90.557</div><div class="line">28:   6033.056 ( 12669500)     RDMA_REQ_COMPLETED                                        id:    r3564            time:  100.211</div></div><!-- fragment --><h1><a class="anchor" id="capture_trace_events"></a>
Capturing sufficient trace events</h1>
<p>Since the tracepoint file generated directly by SPDK application is a circular buffer in shared memory, the trace events captured by it may be insufficient for further analysis. The spdk_trace_record program can be found in the app/trace_record directory. spdk_trace_record is used to poll the spdk tracepoint shared memory, record new entries from it, and store all entries into specified output file at its shutdown on SIGINT or SIGTERM. After SPDK nvmf target is launched, simply execute the command line shown in the log:</p>
<div class="fragment"><div class="line">app/trace_record/spdk_trace_record -q -s nvmf -p 24147 -f /tmp/spdk_nvmf_record.trace</div></div><!-- fragment --><p>Also send I/Os to the SPDK target application to generate events by previous perf example for 10 minutes.</p>
<div class="fragment"><div class="line">./perf -q 128 -s 4096 -w randread -t 600 -r &#39;trtype:RDMA adrfam:IPv4 traddr:192.168.100.2 trsvcid:4420&#39;</div></div><!-- fragment --><p>After the completion of perf example, shut down spdk_trace_record by signal SIGINT (Ctrl + C). To analyze the tracepoints output file from spdk_trace_record, simply run spdk_trace program by:</p>
<div class="fragment"><div class="line">app/trace/spdk_trace -f /tmp/spdk_nvmf_record.trace</div></div><!-- fragment --><h1><a class="anchor" id="add_tracepoints"></a>
Adding New Tracepoints</h1>
<p>SPDK applications and libraries provide several trace points. You can add new tracepoints to the existing trace groups. For example, to add a new tracepoints to the SPDK RDMA library (lib/nvmf/rdma.c) trace group TRACE_GROUP_NVMF_RDMA, define the tracepoints and assigning them a unique ID using the SPDK_TPOINT_ID macro:</p>
<div class="fragment"><div class="line">#define TRACE_GROUP_NVMF_RDMA   0x4</div><div class="line">#define TRACE_RDMA_REQUEST_STATE_NEW    SPDK_TPOINT_ID(TRACE_GROUP_NVMF_RDMA, 0x0)</div><div class="line">...</div><div class="line">#define NEW_TRACE_POINT_NAME    SPDK_TPOINT_ID(TRACE_GROUP_NVMF_RDMA, UNIQUE_ID)</div></div><!-- fragment --><p>You also need to register the new trace points in the SPDK_TRACE_REGISTER_FN macro call within the application/library using the spdk_trace_register_description function as shown below:</p>
<div class="fragment"><div class="line">SPDK_TRACE_REGISTER_FN(nvmf_trace)</div><div class="line">{</div><div class="line">        spdk_trace_register_object(OBJECT_NVMF_RDMA_IO, &#39;r&#39;);</div><div class="line">        spdk_trace_register_description(&quot;RDMA_REQ_NEW&quot;, &quot;&quot;,</div><div class="line">                                        TRACE_RDMA_REQUEST_STATE_NEW,</div><div class="line">                                        OWNER_NONE, OBJECT_NVMF_RDMA_IO, 1, 1, &quot;cmid:   &quot;);</div><div class="line">        ...</div><div class="line">        spdk_trace_register_description(&quot;NEW_RDMA_REQ_NAME&quot;, &quot;&quot;,</div><div class="line">                                        NEW_TRACE_POINT_NAME,</div><div class="line">                                        OWNER_NONE, OBJECT_NVMF_RDMA_IO, 0, 1, &quot;cmid:   &quot;);</div><div class="line">}</div></div><!-- fragment --><p>Finally, use the spdk_trace_record function at the appropriate point in the application/library to record the current trace state for the new trace points. The following example shows the usage of the spdk_trace_record function to record the current trace state of several tracepoints.</p>
<div class="fragment"><div class="line">case RDMA_REQUEST_STATE_NEW:</div><div class="line">        spdk_trace_record(TRACE_RDMA_REQUEST_STATE_NEW, 0, 0, (uintptr_t)rdma_req, (uintptr_t)rqpair-&gt;cm_id);</div><div class="line">        ...</div><div class="line">        break;</div><div class="line">case RDMA_REQUEST_STATE_NEED_BUFFER:</div><div class="line">        spdk_trace_record(TRACE_RDMA_REQUEST_STATE_NEED_BUFFER, 0, 0, (uintptr_t)rdma_req, (uintptr_t)rqpair-&gt;cm_id);</div><div class="line">        ...</div><div class="line">        break;</div><div class="line">case RDMA_REQUEST_STATE_TRANSFER_PENDING_HOST_TO_CONTROLLER:</div><div class="line">        spdk_trace_record(TRACE_RDMA_REQUEST_STATE_TRANSFER_PENDING_HOST_TO_CONTROLLER, 0, 0,</div><div class="line">                (uintptr_t)rdma_req, (uintptr_t)rqpair-&gt;cm_id);</div><div class="line">        ...</div></div><!-- fragment --><p>All the tracing functions are documented in the <a href="https://www.spdk.io/doc/trace_8h.html">Tracepoint library documentation</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</div>
