<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.13">
  <title>SPDK: vhost</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-sm-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://ci.spdk.io/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('vhost.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">vhost </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="vhost_users_guide"></a>
vhost Users Guide</h1>
<p>The Storage Performance Development Kit vhost application is named <code>vhost</code>. This application extends SPDK to present virtio storage controllers to QEMU-based VMs and process I/O submitted to devices attached to those controllers.</p>
<h1><a class="anchor" id="vhost_prereqs"></a>
Prerequisites</h1>
<p>This guide assumes the SPDK has been built according to the instructions in <a class="el" href="getting_started.html">Getting Started</a>. The SPDK vhost target is built with the default configure options.</p>
<h2>Supported Guest Operating Systems</h2>
<p>The guest OS must contain virtio-scsi or virtio-blk drivers. Most Linux and FreeBSD distributions include virtio drivers. <a href="https://fedoraproject.org/wiki/Windows_Virtio_Drivers">Windows virtio drivers</a> must be installed separately. The SPDK vhost target has been tested with Ubuntu 16.04, Fedora 25, and Windows 2012 R2.</p>
<h2>QEMU</h2>
<p>Userspace vhost-scsi target support was added to upstream QEMU in v2.10.0. Userspace vhost-blk target support is not yet upstream in QEMU, but patches are available in SPDK's QEMU repository:</p>
<div class="fragment"><div class="line">git clone -b spdk https://github.com/spdk/qemu</div><div class="line">cd qemu</div><div class="line">mkdir build</div><div class="line">cd build</div><div class="line">../configure</div><div class="line">make</div></div><!-- fragment --><h1><a class="anchor" id="vhost_config"></a>
Configuration</h1>
<h2>SPDK</h2>
<p>A vhost-specific configuration file is used to configure the SPDK vhost target. A fully documented example configuration file is located at <code>etc/spdk/vhost.conf.in</code>. This file defines the following:</p>
<h3>Storage Backends</h3>
<p>Storage backends are devices which will be exposed to the guest OS. Vhost-blk backends are exposed as block devices in the guest OS, and vhost-scsi backends are exposed as SCSI LUNs on devices attached to the vhost-scsi controller in the guest OS. SPDK supports several different types of storage backends, including NVMe, Linux AIO, malloc ramdisk and Ceph RBD. Refer to <a class="el" href="bdev.html#bdev_getting_started">Introduction</a> for additional information on specifying storage backends in the configuration file.</p>
<h3>Mappings Between Block Controllers and Storage Backends</h3>
<p>The vhost target exposes block devices to the virtual machines. The device in the vhost controller is associated with an SPDK block device, and the configuration file defines those associations. The block device to Dev mapping is specified in the configuration file as:</p>
<div class="fragment"><div class="line">[VhostBlkX]</div><div class="line">  Name vhost.X                  # Name of vhost socket</div><div class="line">  Dev BackendX                  # &quot;BackendX&quot; is block device name from previous</div><div class="line">                                # sections in config file</div><div class="line"></div><div class="line">  #Cpumask 0x1                  # Optional parameter defining which core controller uses</div></div><!-- fragment --><h3>Mappings Between SCSI Controllers and Storage Backends</h3>
<p>The vhost target exposes SCSI controllers to the virtual machine application(s). Each SPDK vhost SCSI controller can expose up to eight targets (0..7). LUN 0 of each target is associated with an SPDK block device and configuration file defines those associations. The block device to Target mappings are specified in the configuration file as:</p>
<div class="fragment"><div class="line">[VhostScsiX]</div><div class="line">  Name vhost.X                  # Name of vhost socket</div><div class="line">  Target 0 BackendX             # &quot;BackendX&quot; is block device name from previous</div><div class="line">                                # sections in config file</div><div class="line">  Target 1 BackendY</div><div class="line">  ...</div><div class="line">  Target n BackendN</div><div class="line"></div><div class="line">  #Cpumask 0x1                  # Optional parameter defining which core controller uses</div></div><!-- fragment --><p>Users should update configuration with 'Target' keyword.</p>
<h3>Vhost Sockets</h3>
<p>Userspace vhost uses UNIX domain sockets for communication between QEMU and the vhost target. Each vhost controller is associated with a UNIX domain socket file with filename equal to the Name argument in configuration file. Sockets are created at current working directory when starting the SPDK vhost target.</p>
<h3>Core Affinity Configuration</h3>
<p>Vhost target can be restricted to run on certain cores by specifying a <code>ReactorMask</code>. Default is to allow vhost target work on core 0. For NUMA systems, it is essential to run vhost with cores on each socket to achieve optimal performance.</p>
<p>Each controller may be assigned a set of cores using the optional <code>Cpumask</code> parameter in configuration file. For NUMA systems, the Cpumask should specify cores on the same CPU socket as its associated VM. The <code>vhost</code> application will pick one core from <code>ReactorMask</code> masked by <code>Cpumask</code>. <code>Cpumask</code> must be a subset of <code>ReactorMask</code>.</p>
<h2>QEMU</h2>
<p>Userspace vhost-scsi adds the following command line option for QEMU: </p><div class="fragment"><div class="line">-device vhost-user-scsi-pci,id=scsi0,chardev=char0[,num_queues=N]</div></div><!-- fragment --><p>Userspace vhost-blk adds the following command line option for QEMU: </p><div class="fragment"><div class="line">-device vhost-user-blk-pci,logical_block_size=4096,size=512M,chardev=char0[,num_queues=N]</div></div><!-- fragment --><p>In order to start qemu with vhost you need to specify following options:</p>
<ul>
<li>Socket, which QEMU will use for vhost communication with SPDK: <div class="fragment"><div class="line">-chardev socket,id=char0,path=/path/to/vhost/socket</div></div><!-- fragment --></li>
<li>Hugepages to share memory between vm and vhost target <div class="fragment"><div class="line">-object memory-backend-file,id=mem,size=1G,mem-path=/dev/hugepages,share=on</div></div><!-- fragment --></li>
</ul>
<h1>Running Vhost Target</h1>
<p>To get started, the following example is usually sufficient: </p><div class="fragment"><div class="line">app/vhost/vhost -c /path/to/vhost.conf</div></div><!-- fragment --><p>A full list of command line arguments to vhost can be obtained by: </p><div class="fragment"><div class="line">app/vhost/vhost -h</div></div><!-- fragment --><h2>Multi-Queue Block Layer (blk-mq)</h2>
<p>For best performance use the Linux kernel block multi-queue feature with vhost. To enable it on Linux, it is required to modify kernel options inside the virtual machine.</p>
<p>Instructions below for Ubuntu OS:</p><ol type="1">
<li><code>vi /etc/default/grub</code></li>
<li>Make sure mq is enabled: <code>GRUB_CMDLINE_LINUX="scsi_mod.use_blk_mq=1"</code></li>
<li><code>sudo update-grub</code></li>
<li>Reboot virtual machine</li>
</ol>
<p>To achieve better performance, make sure to increase number of cores assigned to the VM and add <code>num_queues</code> parameter to the QEMU <code>device</code>. It should be enough to set <code>num_queues=4</code> to saturate physical device. Adding too many queues might lead to SPDK vhost performance degradation if many vhost devices are used because each device will require additional <code>num_queues</code> to be polled.</p>
<h1><a class="anchor" id="vhost_example"></a>
Example</h1>
<p>Run SPDK vhost with two controllers: Virtio SCSI and Virtio block.</p>
<p>Virtio SCSI controller with two LUNs:</p>
<ul>
<li>SCSI target 1, LUN 0 backed by Malloc0 bdev</li>
<li>SCSI target 5, LUN 0 backed by Malloc1 bdev</li>
</ul>
<p>Virtio block device backed by Malloc2 bdev</p>
<p>For better performance use 4 VCPU (<code>-smp 4</code>) and 4 queues for each controller (<code>num_queues=4</code>). Assume that QEMU and SPDK are in respectively <code>qemu</code> and <code>spdk</code> directories. </p><div class="fragment"><div class="line">host: $ cd spdk</div><div class="line">host: $ cat vhost.conf</div><div class="line">[Malloc]</div><div class="line">  NumberOfLuns 3</div><div class="line">  LunSizeInMb 128</div><div class="line">  BlockSize 512</div><div class="line"></div><div class="line">[VhostScsi0]</div><div class="line">  Name vhost_scsi0_socket</div><div class="line">  Dev 1 Malloc0</div><div class="line">  Dev 5 Malloc1</div><div class="line"></div><div class="line">[VhostBlk0]</div><div class="line">  Name vhost_blk0_socket</div><div class="line">  Dev Malloc2</div><div class="line"></div><div class="line">host: $ sudo ./app/vhost/vhost -c vhost.conf -s 1024 -m 1 &amp;</div><div class="line">[ DPDK EAL parameters: vhost -c 1 -m 1024 --file-prefix=spdk_pid191213 ]</div><div class="line">EAL: Detected 48 lcore(s)</div><div class="line">EAL: Probing VFIO support...</div><div class="line">EAL: VFIO support initialized</div><div class="line">&lt;&lt; REMOVED CONSOLE LOG &gt;&gt;</div><div class="line">VHOST_CONFIG: bind to vhost_scsi0_socket</div><div class="line">vhost.c: 592:spdk_vhost_dev_construct: *NOTICE*: Controller vhost_scsi0_socket: new controller added</div><div class="line">vhost_scsi.c: 840:spdk_vhost_scsi_dev_add_tgt: *NOTICE*: Controller vhost_scsi0_socket: defined target &#39;Target 1&#39; using lun &#39;Malloc0&#39;</div><div class="line">vhost_scsi.c: 840:spdk_vhost_scsi_dev_add_tgt: *NOTICE*: Controller vhost_scsi0_socket: defined target &#39;Target 5&#39; using lun &#39;Malloc1&#39;</div><div class="line">VHOST_CONFIG: vhost-user server: socket created, fd: 65</div><div class="line">VHOST_CONFIG: bind to vhost_blk0_socket</div><div class="line">vhost.c: 592:spdk_vhost_dev_construct: *NOTICE*: Controller vhost_blk0_socket: new controller added</div><div class="line">vhost_blk.c: 720:spdk_vhost_blk_construct: *NOTICE*: Controller vhost_blk0_socket: using bdev &#39;Malloc2&#39;</div><div class="line"></div><div class="line">host: $ cd ..</div><div class="line">host: $ sudo ./qemu/build/x86_64-softmmu/qemu-system-x86_64 --enable-kvm -m 1024 \</div><div class="line">  -cpu host -smp 4 -nographic \</div><div class="line">  -object memory-backend-file,id=mem,size=1G,mem-path=/dev/hugepages,share=on -numa node,memdev=mem \</div><div class="line">  -drive file=guest_os_image.qcow2,if=none,id=disk \</div><div class="line">  -device ide-hd,drive=disk,bootindex=0 \</div><div class="line">  -chardev socket,id=spdk_vhost_scsi0,path=./spdk/vhost_scsi0_socket \</div><div class="line">  -device vhost-user-scsi-pci,id=scsi0,chardev=spdk_vhost_scsi0,num_queues=4 \</div><div class="line">  -chardev socket,id=spdk_vhost_blk0,path=./spdk/vhost_blk0_socket \</div><div class="line">  -device vhost-user-blk-pci,logical_block_size=512,size=128M,chardev=spdk_vhost_blk0,num_queues=4</div><div class="line"></div><div class="line">&lt;&lt; LOGIN TO GUEST OS &gt;&gt;</div><div class="line">guest: ~$ lsblk --output &quot;NAME,KNAME,MODEL,HCTL,SIZE,VENDOR,SUBSYSTEMS&quot;</div><div class="line">NAME   KNAME MODEL            HCTL        SIZE VENDOR   SUBSYSTEMS</div><div class="line">fd0    fd0                                  4K          block:platform</div><div class="line">sda    sda   QEMU HARDDISK    1:0:0:0      80G ATA      block:scsi:pci</div><div class="line">  sda1 sda1                                80G          block:scsi:pci</div><div class="line">sdb    sdb   Malloc disk      2:0:1:0     128M INTEL    block:scsi:virtio:pci</div><div class="line">sdc    sdc   Malloc disk      2:0:5:0     128M INTEL    block:scsi:virtio:pci</div><div class="line">vda    vda                                128M 0x1af4   block:virtio:pci</div><div class="line"></div><div class="line">guest: $ sudo poweroff</div><div class="line">host: $ fg</div><div class="line">&lt;&lt; CTRL + C &gt;&gt;</div><div class="line">vhost.c:1006:session_shutdown: *NOTICE*: Exiting</div></div><!-- fragment --><p>We can see that <code>sdb</code> and <code>sdc</code> are SPDK vhost-scsi LUNs, and <code>vda</code> is SPDK vhost-blk disk.</p>
<h1><a class="anchor" id="vhost_bugs"></a>
Known bugs and limitations</h1>
<h2>Windows virtio-blk driver before version 0.1.130-1 only works with 512-byte sectors</h2>
<p>The Windows <code>viostor</code> driver before version 0.1.130-1 is buggy and does not correctly support vhost-blk devices with non-512-byte block size. See the <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1411092">bug report</a> for more information. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</div>
