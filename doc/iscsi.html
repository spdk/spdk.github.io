<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.13">
  <title>SPDK: iSCSI Target</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-sm-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://ci.spdk.io/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('iscsi.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">iSCSI Target </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="iscsi_getting_started"></a>
iSCSI Target Getting Started Guide</h1>
<p>The Storage Performance Development Kit iSCSI target application is named <code>iscsi_tgt</code>. This following section describes how to run iscsi from your cloned package.</p>
<h2><a class="anchor" id="iscsi_prereqs"></a>
Prerequisites</h2>
<p>This guide starts by assuming that you can already build the standard SPDK distribution on your platform.</p>
<p>Once built, the binary will be in <code>app/iscsi_tgt</code>.</p>
<p>If you want to kill the application by using signal, make sure use the SIGTERM, then the application will release all the shared memory resource before exit, the SIGKILL will make the shared memory resource have no chance to be released by applications, you may need to release the resource manually.</p>
<h2><a class="anchor" id="iscsi_config"></a>
Configuring iSCSI Target</h2>
<p>A <code>iscsi_tgt</code> specific configuration file is used to configure the iSCSI target. A fully documented example configuration file is located at <code>etc/spdk/iscsi.conf.in</code>.</p>
<p>The configuration file is used to configure the SPDK iSCSI target. This file defines the following: TCP ports to use as iSCSI portals; general iSCSI parameters; initiator names and addresses to allow access to iSCSI target nodes; number and types of storage backends to export over iSCSI LUNs; iSCSI target node mappings between portal groups, initiator groups, and LUNs.</p>
<p>You should make a copy of the example configuration file, modify it to suit your environment, and then run the iscsi_tgt application and pass it the configuration file using the -c option. Right now, the target requires elevated privileges (root) to run.</p>
<div class="fragment"><div class="line">app/iscsi_tgt/iscsi_tgt -c /path/to/iscsi.conf</div></div><!-- fragment --><h2><a class="anchor" id="iscsi_config_lcore"></a>
Assigning CPU Cores to the iSCSI Target</h2>
<p>SPDK uses the <a href="http://dpdk.org/doc/guides/prog_guide/env_abstraction_layer.html">DPDK Environment Abstraction Layer</a> to gain access to hardware resources such as huge memory pages and CPU core(s). DPDK EAL provides functions to assign threads to specific cores. To ensure the SPDK iSCSI target has the best performance, place the NICs and the NVMe devices on the same NUMA node and configure the target to run on CPU cores associated with that node. The following parameters in the configuration file are used to configure SPDK iSCSI target:</p>
<p><b>ReactorMask:</b> A hexadecimal bit mask of the CPU cores that SPDK is allowed to execute work items on. The ReactorMask is located in the [Global] section of the configuration file. For example, to assign lcores 24,25,26 and 27 to iSCSI target work items, set the ReactorMask to: </p><div class="fragment"><div class="line">ReactorMask 0xF000000</div></div><!-- fragment --><h2><a class="anchor" id="iscsi_lun"></a>
Configuring a LUN in the iSCSI Target</h2>
<p>Each LUN in an iSCSI target node is associated with an SPDK block device. See <a class="el" href="bdev.html#bdev_getting_started">Introduction</a> for details on configuring SPDK block devices. The block device to LUN mappings are specified in the configuration file as:</p>
<div class="fragment"><div class="line">[TargetNodeX]</div><div class="line">  LUN0 Malloc0</div><div class="line">  LUN1 Nvme0n1</div></div><!-- fragment --><p>This exports a malloc'd target. The disk is a RAM disk that is a chunk of memory allocated by iscsi in user space. It will use offload engine to do the copy job instead of memcpy if the system has enough DMA channels.</p>
<h2><a class="anchor" id="iscsi_rpc"></a>
Configuring iSCSI Target via RPC method</h2>
<p>In addition to the configuration file, the iSCSI target may also be configured via JSON-RPC calls. See <a class="el" href="jsonrpc.html">JSON-RPC Methods</a> for details.</p>
<h3>Add the portal group</h3>
<div class="fragment"><div class="line">python /path/to/spdk/scripts/rpc.py add_portal_group 1 127.0.0.1:3260</div></div><!-- fragment --><h3>Add the initiator group</h3>
<div class="fragment"><div class="line">python /path/to/spdk/scripts/rpc.py add_initiator_group 2 ANY 127.0.0.1/32</div></div><!-- fragment --><h3>Construct the backend block device</h3>
<div class="fragment"><div class="line">python /path/to/spdk/scripts/rpc.py construct_malloc_bdev -b MyBdev 64 512</div></div><!-- fragment --><h3>Construct the target node</h3>
<div class="fragment"><div class="line">python /path/to/spdk/scripts/rpc.py construct_target_node Target3 Target3_alias MyBdev:0 1:2 64 0 0 0 1</div></div><!-- fragment --><h2><a class="anchor" id="iscsi_initiator"></a>
Configuring iSCSI Initiator</h2>
<p>The Linux initiator is open-iscsi.</p>
<p>Installing open-iscsi package Fedora: </p><div class="fragment"><div class="line">yum install -y iscsi-initiator-utils</div></div><!-- fragment --><p>Ubuntu: </p><div class="fragment"><div class="line">apt-get install -y open-iscsi</div></div><!-- fragment --><h3>Setup</h3>
<p>Edit /etc/iscsi/iscsid.conf </p><div class="fragment"><div class="line">node.session.cmds_max = 4096</div><div class="line">node.session.queue_depth = 128</div></div><!-- fragment --><p>iscsid must be restarted or receive SIGHUP for changes to take effect. To send SIGHUP, run: </p><div class="fragment"><div class="line">killall -HUP iscsid</div></div><!-- fragment --><p>Recommended changes to /etc/sysctl.conf </p><div class="fragment"><div class="line">net.ipv4.tcp_timestamps = 1</div><div class="line">net.ipv4.tcp_sack = 0</div><div class="line"></div><div class="line">net.ipv4.tcp_rmem = 10000000 10000000 10000000</div><div class="line">net.ipv4.tcp_wmem = 10000000 10000000 10000000</div><div class="line">net.ipv4.tcp_mem = 10000000 10000000 10000000</div><div class="line">net.core.rmem_default = 524287</div><div class="line">net.core.wmem_default = 524287</div><div class="line">net.core.rmem_max = 524287</div><div class="line">net.core.wmem_max = 524287</div><div class="line">net.core.optmem_max = 524287</div><div class="line">net.core.netdev_max_backlog = 300000</div></div><!-- fragment --><h3>Discovery</h3>
<p>Assume target is at 192.168.1.5 </p><div class="fragment"><div class="line">iscsiadm -m discovery -t sendtargets -p 192.168.1.5</div></div><!-- fragment --><h3>Connect to target</h3>
<div class="fragment"><div class="line">iscsiadm -m node --login</div></div><!-- fragment --><p>At this point the iSCSI target should show up as SCSI disks. Check dmesg to see what they came up as.</p>
<h3>Disconnect from target</h3>
<div class="fragment"><div class="line">iscsiadm -m node --logout</div></div><!-- fragment --><h3>Deleting target node cache</h3>
<div class="fragment"><div class="line">iscsiadm -m node -o delete</div></div><!-- fragment --><p>This will cause the initiator to forget all previously discovered iSCSI target nodes.</p>
<h3>Finding /dev/sdX nodes for iSCSI LUNs</h3>
<div class="fragment"><div class="line">iscsiadm -m session -P 3 | grep &quot;Attached scsi disk&quot; | awk &#39;{print $4}&#39;</div></div><!-- fragment --><p>This will show the /dev node name for each SCSI LUN in all logged in iSCSI sessions.</p>
<h3>Tuning</h3>
<p>After the targets are connected, they can be tuned. For example if /dev/sdc is an iSCSI disk then the following can be done: Set noop to scheduler</p>
<div class="fragment"><div class="line">echo noop &gt; /sys/block/sdc/queue/scheduler</div></div><!-- fragment --><p>Disable merging/coalescing (can be useful for precise workload measurements)</p>
<div class="fragment"><div class="line">echo &quot;2&quot; &gt; /sys/block/sdc/queue/nomerges</div></div><!-- fragment --><p>Increase requests for block queue</p>
<div class="fragment"><div class="line">echo &quot;1024&quot; &gt; /sys/block/sdc/queue/nr_requests</div></div><!-- fragment --><h1><a class="anchor" id="vpp"></a>
Vector Packet Processing</h1>
<p>VPP (part of <a href="https://fd.io/">Fast Data - Input/Output</a> project) is an extensible userspace framework providing networking functionality. It is build on idea of packet processing graph (see <a href="https://wiki.fd.io/view/VPP/What_is_VPP?">What is VPP?</a>).</p>
<p>A detailed instructions for <b>simplified steps 1-3</b> below, can be found on VPP <a href="https://wiki.fd.io/view/VPP">Quick Start Guide</a>.</p>
<p><em>SPDK supports VPP version 18.01.1.</em></p>
<h2><a class="anchor" id="vpp_build"></a>
1. Building VPP (optional)</h2>
<p><em>Please skip this step if using already built packages.</em></p>
<p>Clone and checkout VPP </p><div class="fragment"><div class="line">git clone https://gerrit.fd.io/r/vpp &amp;&amp; cd vpp</div><div class="line">git checkout v18.01.1</div></div><!-- fragment --><p>Install VPP build dependencies </p><div class="fragment"><div class="line">make install-dep</div></div><!-- fragment --><p>Build and create .rpm packages </p><div class="fragment"><div class="line">make pkg-rpm</div></div><!-- fragment --><p>Alternatively, build and create .deb packages </p><div class="fragment"><div class="line">make pkg-deb</div></div><!-- fragment --><p>Packages can be found in <code>vpp/build-root/</code> directory.</p>
<p>For more in depth instructions please see Building section in <a href="https://wiki.fd.io/view/VPP/Pulling,_Building,_Running,_Hacking_and_Pushing_VPP_Code#Building">VPP documentation</a></p>
<h2><a class="anchor" id="vpp_install"></a>
2. Installing VPP</h2>
<p>Packages can be installed from distribution repository or built in previous step. Minimal set of packages consists of <code>vpp</code>, <code>vpp-lib</code> and <code>vpp-devel</code>.</p>
<p><em>Note: Please remove or modify /etc/sysctl.d/80-vpp.conf file with appropriate values dependent on number of hugepages that will be used on system.</em></p>
<h2><a class="anchor" id="vpp_run"></a>
3. Running VPP</h2>
<p>VPP takes over any network interfaces that were bound to userspace driver, for details please see DPDK guide on <a href="http://dpdk.org/doc/guides/linux_gsg/linux_drivers.html#binding-and-unbinding-network-ports-to-from-the-kernel-modules">Binding and Unbinding Network Ports to/from the Kernel Modules</a>.</p>
<p>VPP is installed as service and disabled by default. To start VPP with default config: </p><div class="fragment"><div class="line">sudo systemctl start vpp</div></div><!-- fragment --><p>Alternatively, use <code>vpp</code> binary directly </p><div class="fragment"><div class="line">sudo vpp unix {cli-listen /run/vpp/cli.sock}</div></div><!-- fragment --><p>A usefull tool is <code>vppctl</code>, that allows to control running VPP instance. Either by entering VPP configuration prompt </p><div class="fragment"><div class="line">sudo vppctl</div></div><!-- fragment --><p>Or, by sending single command directly. For example to display interfaces within VPP: </p><div class="fragment"><div class="line">sudo vppctl show interface</div></div><!-- fragment --><h3>Example: Tap interfaces on single host</h3>
<p>For functional test purpose a virtual tap interface can be created, so no additional network hardware is required. This will allow network communication between SPDK iSCSI target using VPP end of tap and kernel iSCSI initiator using the kernel part of tap. A single host is used in this scenario.</p>
<p>Create tap interface via VPP </p><div class="fragment"><div class="line">vppctl tap connect tap0</div><div class="line">vppctl set interface state tapcli-0 up</div><div class="line">vppctl set interface ip address tapcli-0 10.0.0.1/24</div><div class="line">vppctl show int addr</div></div><!-- fragment --><p>Assign address on kernel interface </p><div class="fragment"><div class="line">sudo ip addr add 10.0.0.2/24 dev tap0</div><div class="line">sudo ip link set tap0 up</div></div><!-- fragment --><p>To verify connectivity </p><div class="fragment"><div class="line">ping 10.0.0.1</div></div><!-- fragment --><h2><a class="anchor" id="vpp_built_into_spdk"></a>
4. Building SPDK with VPP</h2>
<p>Support for VPP can be built into SPDK by using configuration option. </p><div class="fragment"><div class="line">configure --with-vpp</div></div><!-- fragment --><p>Alternatively, directory with built libraries can be pointed at and will be used for compilation instead of installed packages. </p><div class="fragment"><div class="line">configure --with-vpp=/path/to/vpp/repo/build-root/vpp</div></div><!-- fragment --><h2><a class="anchor" id="vpp_running_with_spdk"></a>
5. Running SPDK with VPP</h2>
<p>VPP application has to be started before SPDK iSCSI target, in order to enable usage of network interfaces. After SPDK iSCSI target initialization finishes, interfaces configured within VPP will be available to be configured as portal addresses. Please refer to <a class="el" href="iscsi.html#iscsi_rpc">Configuring iSCSI Target via RPC method</a>.</p>
<h1><a class="anchor" id="iscsi_hotplug"></a>
iSCSI Hotplug</h1>
<p>At the iSCSI level, we provide the following support for Hotplug:</p>
<ol type="1">
<li>bdev/nvme: At the bdev/nvme level, we start one hotplug monitor which will call <a class="el" href="nvme_8h.html#a225bbc386ec518ae21bd5536f21db45d" title="Enumerate the bus indicated by the transport ID and attach the userspace NVMe driver to each device f...">spdk_nvme_probe()</a> periodically to get the hotplug events. We provide the private attach_cb and remove_cb for <a class="el" href="nvme_8h.html#a225bbc386ec518ae21bd5536f21db45d" title="Enumerate the bus indicated by the transport ID and attach the userspace NVMe driver to each device f...">spdk_nvme_probe()</a>. For the attach_cb, we will create the block device base on the NVMe device attached, and for the remove_cb, we will unregister the block device, which will also notify the upper level stack (for iSCSI target, the upper level stack is scsi/lun) to handle the hot-remove event.</li>
<li>scsi/lun: When the LUN receive the hot-remove notification from block device layer, the LUN will be marked as removed, and all the IOs after this point will return with check condition status. Then the LUN starts one poller which will wait for all the commands which have already been submitted to block device to return back; after all the commands return back, the LUN will be deleted.</li>
</ol>
<h2><a class="anchor" id="iscsi_hotplug_bugs"></a>
Known bugs and limitations</h2>
<p>For write command, if you want to test hotplug with write command which will cause r2t, for example 1M size IO, it will crash the iscsi tgt. For read command, if you want to test hotplug with large read IO, for example 1M size IO, it will probably crash the iscsi tgt.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="nvme_8h.html#a225bbc386ec518ae21bd5536f21db45d" title="Enumerate the bus indicated by the transport ID and attach the userspace NVMe driver to each device f...">spdk_nvme_probe</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
</div>
