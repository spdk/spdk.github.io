<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Doxygen 1.9.1" />
  <title>SPDK: SPDK Libraries</title>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="../js/doxyboot.js"></script>
  <script type="text/javascript" src="./navtree.js"></script>
  <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../css/spdk.css" rel="stylesheet" type="text/css">
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark px-2">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/" aria-label="SPDK">
      <img src="/img/spdk.svg"  width="36" height="36" alt="Storage Performance Development Kit" />
    </a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <div class="navbar-nav mr-auto">
        <a class="nav-link header-link active" href="../doc/">Documentation</a>
        <a class="nav-link header-link" href="../development/">Development</a>
        <a class="nav-link header-link" href="../community/">Community</a>
        <a class="nav-link header-link" href="../blog/">Blog</a>
      </div>
      <div class="navbar-nav ml-auto mr-3">
        <a class="nav-link header-link" href="https://github.com/spdk/spdk">
          <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      </div>
    </div>
  </nav>
  <div class="container-fluid doc">
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('libraries.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">SPDK Libraries </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_libraries"></a> The SPDK repository is, first and foremost, a collection of high-performance storage-centric software libraries. With this in mind, much care has been taken to ensure that these libraries have consistent and robust naming and versioning conventions. The libraries themselves are also divided across two directories (<code>lib</code> and <code>module</code>) inside of the SPDK repository in a deliberate way to prevent mixing of SPDK event framework dependent code and lower level libraries. This document is aimed at explaining the structure, naming conventions, versioning scheme, and use cases of the libraries contained in these two directories.</p>
<h1><a class="anchor" id="structure"></a>
Directory Structure</h1>
<p>The SPDK libraries are divided into two directories. The <code>lib</code> directory contains the base libraries that compose SPDK. Some of these base libraries define plug-in systems. Instances of those plug-ins are called modules and are located in the <code>module</code> directory. For example, the <code>spdk_sock</code> library is contained in the <code>lib</code> directory while the implementations of socket abstractions, <code>sock_posix</code> and <code>sock_uring</code> are contained in the <code>module</code> directory.</p>
<h2><a class="anchor" id="lib"></a>
lib</h2>
<p>The libraries in the <code>lib</code> directory can be readily divided into four categories:</p>
<ul>
<li>Utility Libraries: These libraries contain basic, commonly used functions that make more complex libraries easier to implement. For example, <code>spdk_log</code> contains macro definitions that provide a consistent logging paradigm and <code>spdk_json</code> is a general purpose JSON parsing library.</li>
<li>Protocol Libraries: These libraries contain the building blocks for a specific service. For example, <code>spdk_nvmf</code> and <code>spdk_vhost</code> each define the storage protocols after which they are named.</li>
<li>Storage Service Libraries: These libraries provide a specific abstraction that can be mapped to somewhere between the physical drive and the filesystem level of your typical storage stack. For example <code><a class="el" href="structspdk__bdev.html">spdk_bdev</a></code> provides a general block device abstraction layer, <code>spdk_lvol</code> provides a logical volume abstraction, <code>spdk_blobfs</code> provides a filesystem abstraction, and <code>spdk_ftl</code> provides a flash translation layer abstraction.</li>
<li>System Libraries: These libraries provide system level services such as a JSON based RPC service (see <code>spdk_jsonrpc</code>) and thread abstractions (see <code>spdk_thread</code>). The most notable library in this category is the <code>spdk_env_dpdk</code> library which provides a shim for the underlying Data Plane Development Kit (DPDK) environment and provides services like memory management.</li>
</ul>
<p>The one library in the <code>lib</code> directory that doesn't fit into the above classification is the <code>spdk_event</code> library. This library defines a framework used by the applications contained in the <code>app</code> and <code>example</code> directories. Much care has been taken to keep the SPDK libraries independent from this framework. The libraries in <code>lib</code> are engineered to allow plugging directly into independent application frameworks such as Seastar or libuv with minimal effort.</p>
<p>Currently there are two exceptions in the <code>lib</code> directory which still rely on <code>spdk_event</code>, <code>spdk_vhost</code> and <code>spdk_iscsi</code>. There are efforts underway to remove all remaining dependencies these libraries have on the <code>spdk_event</code> library.</p>
<p>Much like the <code>spdk_event</code> library, the <code>spdk_env_dpdk</code> library has been architected in such a way that it can be readily replaced by an alternate environment shim. More information on replacing the <code>spdk_env_dpdk</code> module and the underlying <code>dpdk</code> environment can be found in the <a href="#env_replacement">environment</a> section.</p>
<h2><a class="anchor" id="module"></a>
module</h2>
<p>The component libraries in the <code>module</code> directory represent specific implementations of the base libraries in the <code>lib</code> directory. As with the <code>lib</code> directory, much care has been taken to avoid dependencies on the <code>spdk_event</code> framework except for those libraries which directly implement the <code>spdk_event</code> module plugin system.</p>
<p>There are seven sub-directories in the <code>module</code> directory which each hold a different class of libraries. These sub-directories can be divided into two types.</p>
<ul>
<li>plug-in libraries: These libraries are explicitly tied to one of the libraries in the <code>lib</code> directory and are registered with that library at runtime by way of a specific constructor function. The parent library in the <code>lib</code> directory then manages the module directly. These types of libraries each implement a function table defined by their parent library. The following table shows these directories and their corresponding parent libraries:</li>
</ul>
<center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">module directory   </th><th class="markdownTableHeadNone">parent library   </th><th class="markdownTableHeadNone">dependent on event library    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">module/accel   </td><td class="markdownTableBodyNone">spdk_accel   </td><td class="markdownTableBodyNone">no    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">module/bdev   </td><td class="markdownTableBodyNone"><a class="el" href="structspdk__bdev.html">spdk_bdev</a>   </td><td class="markdownTableBodyNone">no    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">module/event   </td><td class="markdownTableBodyNone">spdk_event   </td><td class="markdownTableBodyNone">yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">module/sock   </td><td class="markdownTableBodyNone">spdk_sock   </td><td class="markdownTableBodyNone">no   </td></tr>
</table>
</center><ul>
<li>Free libraries: These libraries are highly dependent upon a library in the <code>lib</code> directory but are not explicitly registered to that library via a constructor. The libraries in the <code>blob</code>, <code>blobfs</code>, and <code>env_dpdk</code> directories fall into this category. None of the libraries in this category depend explicitly on the <code>spdk_event</code> library.</li>
</ul>
<h1><a class="anchor" id="conventions"></a>
Library Conventions</h1>
<p>The SPDK libraries follow strict conventions for naming functions, logging, versioning, and header files.</p>
<h2><a class="anchor" id="headers"></a>
Headers</h2>
<p>All public SPDK header files exist in the <code>include</code> directory of the SPDK repository. These headers are divided into two sub-directories.</p>
<p><code>include/spdk</code> contains headers intended to be used by consumers of the SPDK libraries. All of the functions, variables, and types in these functions are intended for public consumption. Multiple headers in this directory may depend upon the same underlying library and work together to expose different facets of the library. The <code><a class="el" href="structspdk__bdev.html">spdk_bdev</a></code> library, for example, is exposed in three different headers. <code><a class="el" href="bdev__module_8h.html" title="Block Device Module Interface.">bdev_module.h</a></code> defines the interfaces a bdev module library would need to implement, <code><a class="el" href="bdev_8h.html" title="Block device abstraction layer.">bdev.h</a></code> contains general block device functions that would be used by an application consuming block devices exposed by SPDK, and <code><a class="el" href="bdev__zone_8h.html" title="Zoned device public interface.">bdev_zone.h</a></code> exposes zoned bdev specific functions. Many of the other libraries exhibit a similar behavior of splitting headers between consumers of the library and those wishing to register a module with that library.</p>
<p><code>include/spdk_internal</code>, as its name suggests contains header files intended to be consumed only by other libraries inside of the SPDK repository. These headers are typically used for sharing lower level functions between two libraries that both require similar functions. For example <code>spdk_internal/nvme_tcp.h</code> contains low level tcp functions used by both the <code>spdk_nvme</code> and <code>spdk_nvmf</code> libraries. These headers are <em>NOT</em> intended for general consumption.</p>
<p>Other header files contained directly in the <code>lib</code> and <code>module</code> directories are intended to be consumed <em>only</em> by source files of their corresponding library. Any symbols intended to be used across libraries need to be included in a header in the <code>include/spdk_internal</code> directory.</p>
<h2><a class="anchor" id="naming"></a>
Naming Conventions</h2>
<p>All public types and functions in SPDK libraries begin with the prefix <code>spdk_</code>. They are also typically further namespaced using the spdk library name. The rest of the function or type name describes its purpose.</p>
<p>There are no internal library functions that begin with the <code>spdk_</code> prefix. This naming convention is enforced by the SPDK continuous Integration testing. Functions not intended for use outside of their home library should be namespaced with the name of the library only.</p>
<h2><a class="anchor" id="map"></a>
Map Files</h2>
<p>SPDK libraries can be built as both static and shared object files. To facilitate building libraries as shared objects, each one has a corresponding map file (e.g. <code>spdk_nvmf</code> relies on <code>spdk_nvmf.map</code>). SPDK libraries not exporting any symbols rely on a blank map file located at <code>mk/spdk_blank.map</code>.</p>
<h1><a class="anchor" id="shared_objects"></a>
SPDK Shared Objects</h1>
<h2><a class="anchor" id="versioning"></a>
Shared Object Versioning</h2>
<p>SPDK shared objects follow a semantic versioning pattern with a major and minor version. Any changes which break backwards compatibility (symbol removal or change) will cause a shared object major increment and backwards compatible changes will cause a minor version increment; i.e. an application that relies on <code>libspdk_nvmf.so.3.0</code> will be compatible with <code>libspdk_nvmf.so.3.1</code> but not with <code>libspdk_nvmf.so.4.0</code>.</p>
<p>Shared object versions are incremented only once between each release cycle. This means that at most, the major version of each SPDK shared library will increment only once between each SPDK release.</p>
<p>There are currently no guarantees in SPDK of ABI compatibility between two major SPDK releases.</p>
<p>The point releases of an LTS release will be ABI compatible with the corresponding LTS major release.</p>
<p>Shared objects are versioned independently of one another. This means that <code>libspdk_nvme.so.3.0</code> and <code>libspdk_bdev.so.3.0</code> do not necessarily belong to the same release. This also means that shared objects with the same suffix are not necessarily compatible with each other. It is important to source all of your SPDK libraries from the same repository and version to ensure inter-library compatibility.</p>
<h2><a class="anchor" id="so_linking"></a>
Linking to Shared Objects</h2>
<p>Shared objects in SPDK are created on a per-library basis. There is a top level <code>libspdk.so</code> object which is a linker script. It simply contains references to all of the other spdk shared objects.</p>
<p>There are essentially two ways of linking to SPDK libraries.</p>
<ol type="1">
<li>An application can link to the top level shared object library as follows: <div class="fragment"><div class="line">gcc -o my_app ./my_app.c -lspdk -lspdk_env_dpdk -ldpdk</div>
</div><!-- fragment --></li>
<li>An application can link to only a subset of libraries by linking directly to the ones it relies on: <div class="fragment"><div class="line">gcc -o my_app ./my_app.c -lpassthru_external -lspdk_event_bdev -lspdk_bdev -lspdk_bdev_malloc</div>
<div class="line">-lspdk_log -lspdk_thread -lspdk_util -lspdk_event -lspdk_env_dpdk -ldpdk</div>
</div><!-- fragment --></li>
</ol>
<p>In the second instance, please note that applications need only link to the libraries upon which they directly depend. All SPDK libraries have their dependencies specified at object compile time. This means that when linking to <code>spdk_net</code>, one does not also have to specify <code>spdk_log</code>, <code>spdk_util</code>, <code>spdk_json</code>, <code>spdk_jsonrpc</code>, and <code>spdk_rpc</code>. However, this dependency inclusion does not extend to the application itself; i.e. if an application directly uses symbols from both <code><a class="el" href="structspdk__bdev.html">spdk_bdev</a></code> and <code>spdk_log</code>, both libraries will need to be supplied to the linker when linking the application even though <code>spdk_log</code> is a dependency of <code><a class="el" href="structspdk__bdev.html">spdk_bdev</a></code>.</p>
<p>Please also note that when linking to SPDK libraries, both the spdk_env shim library and the env library itself need to be supplied to the linker. In the examples above, these are <code>spdk_env_dpdk</code> and <code>dpdk</code> respectively. This was intentional and allows one to easily swap out both the environment and the environment shim.</p>
<h2><a class="anchor" id="env_replacement"></a>
Replacing the env abstraction</h2>
<p>SPDK depends on an environment abstraction that provides crucial pinned memory management and PCIe bus management operations. The interface for this environment abstraction is defined in the <code>include/env.h</code> header file. The default implementation of this environment is located in <code>spdk_env_dpdk</code>. This abstraction in turn relies upon the DPDK libraries. This two part implementation was deliberate and allows for easily swapping out the dpdk version upon which the spdk libraries rely without making modifications to the spdk source directly.</p>
<p>Any environment can replace the <code>spdk_env_dpdk</code> environment by implementing the <code>include/env.h</code> header file. The environment can either be implemented wholesale in a single library or as a two-part shim/implementation library system.</p>
<div class="fragment"><div class="line"># single library</div>
<div class="line">gcc -o my_app ./my_app.c -lspdk -lcustom_env_implementation</div>
<div class="line"> </div>
<div class="line"># two libraries</div>
<div class="line">gcc -o my_app ./my_app.c -lspdk -lcustom_env_shim -lcustom_env_implementation</div>
</div><!-- fragment --><h1><a class="anchor" id="static_objects"></a>
SPDK Static Objects</h1>
<p>SPDK static objects are compiled by default even when no parameters are supplied to the build system. Unlike SPDK shared objects, the filename does not contain any versioning semantics. Linking against static objects is similar to shared objects but will always require the use of <code>-Wl,--whole-archive</code> as argument. This is due to the use of constructor functions in SPDK such as those to register NVMe transports.</p>
<p>Due to the lack of versioning semantics, it is not recommended to install static libraries system wide. Instead the path to these static libraries should be added as argument at compile time using <code>-L/path/to/static/libs</code>. The use of static objects instead of shared objects can also be forced through <code>-Wl,-Bstatic</code>, otherwise some compilers might prefer to use the shared objects if both are available.</p>
<div class="fragment"><div class="line">gcc -o my_app ./my_app.c -L/path/to/static/libs -Wl,--whole-archive -Wl,-Bstatic -lpassthru_external</div>
<div class="line">-lspdk_event_bdev -lspdk_bdev -lspdk_bdev_malloc -lspdk_log -lspdk_thread -lspdk_util -lspdk_event</div>
<div class="line">-lspdk_env_dpdk -Wl,--no-whole-archive -Wl,-Bdynamic -pthread -ldpdk</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
<ul>
        <li class="footer">Generated by
        <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.1 </li>
</ul>
</div>
</div>
</body>
</html>
