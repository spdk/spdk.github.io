<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Doxygen 1.9.1" />
  <title>SPDK: Storage Management Agent</title>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="../js/doxyboot.js"></script>
  <script type="text/javascript" src="./navtree.js"></script>
  <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../css/spdk.css" rel="stylesheet" type="text/css">
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark px-2">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/" aria-label="SPDK">
      <img src="/img/spdk.svg"  width="36" height="36" alt="Storage Performance Development Kit" />
    </a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <div class="navbar-nav mr-auto">
        <a class="nav-link header-link active" href="../doc/">Documentation</a>
        <a class="nav-link header-link" href="../development/">Development</a>
        <a class="nav-link header-link" href="../community/">Community</a>
        <a class="nav-link header-link" href="../blog/">Blog</a>
      </div>
      <div class="navbar-nav ml-auto mr-3">
        <a class="nav-link header-link" href="https://github.com/spdk/spdk">
          <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      </div>
    </div>
  </nav>
  <div class="container-fluid doc">
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sma.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Storage Management Agent </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_sma"></a> Storage Management Agent (SMA) is a service providing a gRPC interface for orchestrating SPDK applications. It's a standalone application that allows users to create and manage various types of devices (e.g. NVMe, virtio-blk, etc.). The major difference between SMA's API and the existing SPDK-RPC interface is that it's designed to abstract the low level details exposed by SPDK-RPCs, which enables it to be more easily consumed by orchestration frameworks, such as k8s or OpenStack. This is especially important for deployments on IPUs (Infrastructure Processing Unit), which usually require a lot of hardware-specific options.</p>
<h1>Interface</h1>
<p>The interface is defined in a protobuf files located in <code>proto</code> directory. The generic interface common to all types of devices is defined in <code>sma.proto</code> file, while device-specific options are defined in their separate files (e.g. <code>nvme.proto</code> for NVMe).</p>
<p>Currently, the interface consists of four methods. Additionally, it defines two main types of objects: volumes and devices. A volume is a representation of some storage media. It is equivalent to a SPDK bdev and/or an NVMe namespace and can exist even if it's not presented to the host system. A device is usually a virtual/physical PCIe function that is exposed to a host. It is capable of presenting one or more volumes (depending on the type of the device) to a host.</p>
<p>The following sections provide a high-level description of each method. For more details, consult the protobuf definitions.</p>
<h2>CreateDevice</h2>
<p>This method creates a device. If a device with given parameters already exists, it becomes a no-op and returns a handle to that device.</p>
<p>Input:</p>
<ul>
<li><code>volume</code>: Volume parameters describing a volume to immediately attach to the created device. This field may be optional for some device types (e.g. NVMe), while it may be required for others (e.g. virtio-blk). Extending parameters with crypto attributes like encryption type, keys, tweak mode allows the user to configure crypto when attaching a volume to a device. Users must specify the crypto engine to use under <code>crypto</code> section in config. It is also possible to register out-of-tree crypto engines by inheriting from the <code>CryptoEngine</code> class.</li>
<li><code>params</code>: Device-specific parameters. The type of this structure determines the type of device to create.</li>
</ul>
<p>Output:</p>
<ul>
<li><code>handle</code>: Opaque handle identifying the device.</li>
</ul>
<h2>DeleteDevice</h2>
<p>This method deletes a device. Volumes that are still attached to a device being deleted will be automatically detached.</p>
<p>Input:</p>
<ul>
<li><code>handle</code>: Device handle obtained from <code>CreateDevice</code>.</li>
</ul>
<h2>AttachVolume</h2>
<p>This method creates a volume and attaches it to a device exposing it to the host. It might lead to establishing a connection to remote storage target. However, this is not always the case, even if the volume is remote. For instance, if a volume describes an NVMe namespace, it might already be connected if another volume on the same subsystem was created previously. It may be unsupported by some types of devices (e.g. virtio-blk).</p>
<p>Input:</p>
<ul>
<li><code>volume</code>: Parameters describing the volume to attach. The type of this structure determines the method to create it (e.g. direct NVMe-oF connection, NVMe-oF through discovery service, iSCSI, etc.). Extending parameters with crypto attributes like type, keys, tweak mode allowing the user to configure crypto when attaching a volume to a device. Users must specify the crypto engine to use under <code>crypto</code> section in config. It is also possible to register out-of-tree crypto engines by inheriting from the <code>CryptoEngine</code> class.</li>
<li><code>device_handle</code>: Device handle obtained from <code>CreateDevice</code>.</li>
</ul>
<h2>DetachVolume</h2>
<p>This method detaches a volume from a device making it unavailable to the host. It may be unsupported by some types of devices (e.g. virtio-blk).</p>
<p>Input:</p>
<ul>
<li><code>volume_id</code>: Volume UUID/GUID.</li>
<li><code>device_handle</code>: Device handle obtained from <code>CreateDevice</code>.</li>
</ul>
<h2>SetQos</h2>
<p>This method configures QoS on a per-device or per-volume level. Not all QoS settings have to be supported by each device, so users can use <code>GetQosCapabilities</code> to get capabilities.</p>
<p>Input:</p>
<ul>
<li><code>handle</code>: Device handle obtained from <code>CreateDevice</code>.</li>
<li><code>volume_id</code>: Volume UUID/GUID. If this parameter is omitted, the QoS will be set up on the whole device (all volumes attached to that device will share QoS settings). Some device types might only support configuring QoS on per-device (volume_id must be empty) or per-volume level (volume_id cannot be empty). This information can be obtained by sending a GetQosCapabilities request.</li>
<li><code>maximum</code>: Maximum allowed IOPS/bandwidth values.</li>
</ul>
<h2>GetQosCapabilities</h2>
<p>This method queries supported QoS settings.</p>
<p>Input:</p>
<ul>
<li><code>device_type</code>: Type of a device to query for QoS capabilities.</li>
</ul>
<p>Output:</p>
<ul>
<li><code>capabilities</code>: QoS capabilities response including device/volume QoS limits like read IOPS, write IOPS, read/write IOPS, read bandwidth, write bandwidth, read/write bandwidth.</li>
</ul>
<h1>Running and Configuration</h1>
<p>In order to run SMA, SPDK needs to be configured with the <code>--with-sma</code> flag. Then, SMA can be started using a script located in <code>scripts/sma.py</code>. It requires a YAML configuration file that specifies which types of devices to service, as well as several other options (e.g. listen address, SPDK-RPC socket, etc.). Device types not listed in the configuration will be disabled and it won't be possible to manage them. Below is an example configuration enabling two device types (NVMe/vfiouser and vhost-blk):</p>
<div class="fragment"><div class="line">address: &#39;localhost&#39;</div>
<div class="line">socket: &#39;/var/tmp/spdk.sock&#39;</div>
<div class="line">port: 8080</div>
<div class="line">devices:</div>
<div class="line">  - name: &#39;vfiouser&#39;</div>
<div class="line">    params:</div>
<div class="line">      root_path: &#39;/var/tmp/vfiouser&#39;</div>
<div class="line">      bus: &#39;bus0&#39;</div>
<div class="line">      address: &#39;127.0.0.1&#39;</div>
<div class="line">      port: 4444</div>
<div class="line">  - name: &#39;vhost-blk&#39;</div>
</div><!-- fragment --><h1>Plugins</h1>
<p>SMA provides a way to load external plugins implementing support for specific device types. A plugin will be loaded if it's specified in the <code>SMA_PLUGINS</code> environment variable (multiple plugins are separated with a colon) or if it's specified in the <code>plugins</code> section of the config file. For example, the following two methods are equivalent:</p>
<div class="fragment"><div class="line">$ SMA_PLUGINS=plugin1:plugin2 scripts/sma.py</div>
<div class="line"> </div>
<div class="line">$ cat sma.yaml</div>
<div class="line">address: &#39;localhost&#39;</div>
<div class="line">port: 8080</div>
<div class="line">plugins:</div>
<div class="line">  - &#39;plugin1&#39;</div>
<div class="line">  - &#39;plugin2&#39;</div>
<div class="line">devices:</div>
<div class="line">  - name: &#39;device-from-plugin1&#39;</div>
<div class="line">  - name: &#39;device-from-plugin2&#39;</div>
<div class="line">$ scripts/sma.py -c sma.yaml</div>
</div><!-- fragment --><p>Each plugin needs to be in the python search path (either in one of the default directories or added to <code>PYTHONPATH</code>).</p>
<p>A plugin is required to define a global variable called <code>devices</code> storing a list of classes deriving from <code>spdk.sma.DeviceManager</code>. This base class define the interface each device needs to implement. Additionally, each DeviceManager needs to define a unique name that will be used to identify it in config file as well as the name of the protocol it supports. There can be many DeviceManagers supporting the same protocol, but only one can be active at a time. The name of the protocol shall match the type specified in <code>CreateDeviceRequest.params</code> (e.g. "nvme", "virtio_blk", etc.), as it'll be used to select the DeviceManager to handle a gRPC request. Finally, a DeviceManager needs to implement the <code>own_device()</code> method returning a boolean value indicating whether a given device handle is owned by that DeviceManager. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
<ul>
        <li class="footer">Generated by
        <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.1 </li>
</ul>
</div>
</div>
</body>
</html>
