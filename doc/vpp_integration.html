<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.15">
  <title>SPDK: Vector Packet Processing</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="two.min.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-xs-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://spdk.io/ci/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://trello.com/b/MN8auadQ/spdk-roadmap">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('vpp_integration.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Vector Packet Processing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>VPP (part of <a href="https://fd.io/">Fast Data - Input/Output</a> project) is an extensible userspace framework providing networking functionality. It is built around the concept of packet processing graph (see <a href="https://wiki.fd.io/view/VPP/What_is_VPP?">What is VPP?</a>).</p>
<p>Detailed instructions for <b>simplified steps 1-3</b> below, can be found on VPP <a href="https://wiki.fd.io/view/VPP">Quick Start Guide</a>.</p>
<p><em>SPDK supports VPP version 19.04.2.</em></p>
<h1><a class="anchor" id="vpp_build"></a>
1. Building VPP (optional)</h1>
<p><em>Please skip this step if using already built packages.</em></p>
<p>Clone and checkout VPP </p><div class="fragment"><div class="line">git clone https://gerrit.fd.io/r/vpp &amp;&amp; cd vpp</div><div class="line">git checkout v19.04.2</div></div><!-- fragment --><p>Install VPP build dependencies </p><div class="fragment"><div class="line">make install-dep</div></div><!-- fragment --><p>Build and create .rpm packages </p><div class="fragment"><div class="line">make pkg-rpm</div></div><!-- fragment --><p>Alternatively, build and create .deb packages </p><div class="fragment"><div class="line">make bootstrap &amp;&amp; make pkg-deb</div></div><!-- fragment --><p>Packages can be found in <code>vpp/build-root/</code> directory.</p>
<p>For more in depth instructions please see Building section in <a href="https://wiki.fd.io/view/VPP/Pulling,_Building,_Running,_Hacking_and_Pushing_VPP_Code#Building">VPP documentation</a></p>
<h1><a class="anchor" id="vpp_install"></a>
2. Installing VPP</h1>
<p>Packages can be installed from a distribution repository or built in previous step. Minimal set of packages consists of <code>vpp</code>, <code>vpp-lib</code> and <code>vpp-devel</code>.</p>
<p><em>Note: Please remove or modify /etc/sysctl.d/80-vpp.conf file with appropriate values dependent on number of hugepages that will be used on system.</em></p>
<h1><a class="anchor" id="vpp_run"></a>
3. Running VPP</h1>
<p>VPP takes over any network interfaces that were bound to userspace driver, for details please see DPDK guide on <a href="http://dpdk.org/doc/guides/linux_gsg/linux_drivers.html#binding-and-unbinding-network-ports-to-from-the-kernel-modules">Binding and Unbinding Network Ports to/from the Kernel Modules</a>.</p>
<p>VPP is installed as service and disabled by default. To start VPP with default config: </p><div class="fragment"><div class="line">sudo systemctl start vpp</div></div><!-- fragment --><p>Alternatively, use <code>vpp</code> binary directly </p><div class="fragment"><div class="line">sudo vpp unix {cli-listen /run/vpp/cli.sock} session { evt_qs_memfd_seg } socksvr { socket-name /run/vpp-api.sock }</div></div><!-- fragment --><h1><a class="anchor" id="vpp_config"></a>
4. Configure VPP</h1>
<p>VPP can be configured using a VPP startup file and the <code>vppctl</code> command; By default, the VPP startup file is <code>/etc/vpp/startup.conf</code>, however, you can pass any file with the <code>-c</code> vpp command argument.</p>
<h2>Startup configuration</h2>
<p>Some key values from iSCSI point of view includes:</p>
<p>CPU section (<code>cpu</code>):</p>
<ul>
<li><code>main-core &lt;lcore&gt;</code> &ndash; logical CPU core used for main thread.</li>
<li><code>corelist-workers &lt;lcore list&gt;</code> &ndash; logical CPU cores where worker threads are running.</li>
</ul>
<p>DPDK section (<code>dpdk</code>):</p>
<ul>
<li><code>num-rx-queues &lt;num&gt;</code> &ndash; number of receive queues.</li>
<li><code>num-tx-queues &lt;num&gt;</code> &ndash; number of transmit queues.</li>
<li><code>dev &lt;PCI address&gt;</code> &ndash; whitelisted device.</li>
</ul>
<p>Session section (<code>session</code>):</p>
<ul>
<li><code>evt_qs_memfd_seg</code> &ndash; uses a memfd segment for event queues. This is required for SPDK.</li>
</ul>
<p>Socket server session (<code>socksvr</code>):</p>
<ul>
<li><code>socket-name &lt;path&gt;</code> &ndash; configure API socket filename (curently SPDK uses default path <code>/run/vpp-api.sock</code>).</li>
</ul>
<p>Plugins section (<code>plugins</code>):</p>
<ul>
<li><code>plugin &lt;plugin name&gt; { [enable|disable] }</code> &ndash; enable or disable VPP plugin.</li>
</ul>
<h3>Example</h3>
<div class="fragment"><div class="line">unix {</div><div class="line">        nodaemon</div><div class="line">        cli-listen /run/vpp/cli.sock</div><div class="line">}</div><div class="line">cpu {</div><div class="line">        main-core 1</div><div class="line">}</div><div class="line">session {</div><div class="line">        evt_qs_memfd_seg</div><div class="line">}</div><div class="line">socksvr {</div><div class="line">        socket-name /run/vpp-api.sock</div><div class="line">}</div><div class="line">plugins {</div><div class="line">        plugin default { disable }</div><div class="line">        plugin dpdk_plugin.so { enable }</div><div class="line">}</div></div><!-- fragment --><h2>vppctl command tool</h2>
<p>The <code>vppctl</code> command tool allows users to control VPP at runtime via a command prompt </p><div class="fragment"><div class="line">sudo vppctl</div></div><!-- fragment --><p>Or, by sending single command directly. For example to display interfaces within VPP: </p><div class="fragment"><div class="line">sudo vppctl show interface</div></div><!-- fragment --><p>Useful commands:</p>
<ul>
<li><code>show interface</code> &ndash; show interfaces settings, state and some basic statistics.</li>
<li><code>show interface address</code> &ndash; show interfaces state and assigned addresses.</li>
<li><code>set interface ip address &lt;VPP interface&gt; &lt;Address&gt;</code> &ndash; set interfaces IP address.</li>
<li><code>set interface state &lt;VPP interface&gt; [up|down]</code> &ndash; bring interface up or down.</li>
<li><code>show errors</code> &ndash; show error counts.</li>
</ul>
<h2>Example: Configure two interfaces to be available via VPP</h2>
<p>We want to configure two DPDK ports with PCI addresses 0000:09:00.1 and 0000:0b:00.1 to be used as portals 10.0.0.1/24 and 10.10.0.1/24.</p>
<p>In the VPP startup file (e.g. <code>/etc/vpp/startup.conf</code>), whitelist the interfaces by specifying PCI addresses in section dpdk: </p><div class="fragment"><div class="line">dev 0000:09:00.1</div><div class="line">dev 0000:0b:00.1</div></div><!-- fragment --><p>Bind PCI NICs to UIO driver (<code>igb_uio</code> or <code>uio_pci_generic</code>).</p>
<p>Restart vpp and use vppctl tool to verify interfaces. </p><div class="fragment"><div class="line">$ vppctl show interface</div><div class="line">              Name               Idx    State  MTU (L3/IP4/IP6/MPLS)     Counter          Count</div><div class="line"></div><div class="line">FortyGigabitEthernet9/0/1         1     down         9000/0/0/0</div><div class="line">FortyGigabitEthernetb/0/1         2     down         9000/0/0/0</div></div><!-- fragment --><p>Set appropriate addresses and bring interfaces up: </p><div class="fragment"><div class="line">$ vppctl set interface ip address FortyGigabitEthernet9/0/1 10.0.0.1/24</div><div class="line">$ vppctl set interface state FortyGigabitEthernet9/0/1 up</div><div class="line">$ vppctl set interface ip address FortyGigabitEthernetb/0/1 10.10.0.1/24</div><div class="line">$ vppctl set interface state FortyGigabitEthernetb/0/1 up</div></div><!-- fragment --><p>Verify configuration: </p><div class="fragment"><div class="line">$ vppctl show interface address</div><div class="line">FortyGigabitEthernet9/0/1 (up):</div><div class="line">  L3 10.0.0.1/24</div><div class="line">FortyGigabitEthernetb/0/1 (up):</div><div class="line">  L3 10.10.0.1/24</div></div><!-- fragment --><p>Now, both interfaces are ready to use. To verify conectivity you can ping 10.0.0.1 and 10.10.0.1 addresses from another machine.</p>
<h2>Example: Tap interfaces on single host</h2>
<p>For functional test purposes a virtual tap interface can be created, so no additional network hardware is required. This will allow network communication between SPDK iSCSI target using VPP end of tap and kernel iSCSI initiator using the kernel part of tap. A single host is used in this scenario.</p>
<p>Create tap interface via VPP </p><div class="fragment"><div class="line">vppctl tap connect tap0</div><div class="line">vppctl set interface state tapcli-0 up</div><div class="line">vppctl set interface ip address tapcli-0 10.0.0.1/24</div><div class="line">vppctl show int addr</div></div><!-- fragment --><p>Assign address on kernel interface </p><div class="fragment"><div class="line">sudo ip addr add 10.0.0.2/24 dev tap0</div><div class="line">sudo ip link set tap0 up</div></div><!-- fragment --><p>To verify connectivity </p><div class="fragment"><div class="line">ping 10.0.0.1</div></div><!-- fragment --><h1><a class="anchor" id="vpp_built_into_spdk"></a>
5. Building SPDK with VPP</h1>
<p>Support for VPP can be built into SPDK by using configuration option. </p><div class="fragment"><div class="line">configure --with-vpp</div></div><!-- fragment --><p>Alternatively, directory with built libraries can be pointed at and will be used for compilation instead of installed packages. </p><div class="fragment"><div class="line">configure --with-vpp=/path/to/vpp/repo/build-root/install-vpp-native/vpp</div></div><!-- fragment --><h1><a class="anchor" id="vpp_running_with_spdk"></a>
6. Running SPDK with VPP</h1>
<p>VPP application has to be started before SPDK application, in order to enable usage of network interfaces. For example, if you use SPDK iSCSI target or NVMe-oF target, after the initialization finishes, interfaces configured within VPP will be available to be configured as portal addresses.</p>
<p>Moreover, you do not need to specifiy which TCP sock implementation (e.g., posix, VPP) to be used through configuration file or RPC call. Since SPDK program automatically determines the protocol according to the configured portal addresses info. For example, you can specify a Listen address in NVMe-oF subsystem configuration such as "Listen TCP 10.0.0.1:4420". SPDK programs automatically uses different implemenation to listen this provided portal info via posix or vpp implemenation(if compiled in SPDK program), and only one implementation can successfully listen on the provided portal. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
</div>
