<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.13">
  <title>SPDK: Block Device User Guide</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-sm-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://ci.spdk.io/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bdev.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Block Device User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="bdev_ug_introduction"></a>
Introduction</h1>
<p>The SPDK block device layer, often simply called <em>bdev</em>, is a C library intended to be equivalent to the operating system block storage layer that often sits immediately above the device drivers in a traditional kernel storage stack. Specifically, this library provides the following functionality:</p>
<ul>
<li>A pluggable module API for implementing block devices that interface with different types of block storage devices.</li>
<li>Driver modules for NVMe, malloc (ramdisk), Linux AIO, virtio-scsi, Ceph RBD, Pmem and Vhost-SCSI Initiator and more.</li>
<li>An application API for enumerating and claiming SPDK block devices and then performing operations (read, write, unmap, etc.) on those devices.</li>
<li>Facilities to stack block devices to create complex I/O pipelines, including logical volume management (lvol) and partition support (GPT).</li>
<li>Configuration of block devices via JSON-RPC.</li>
<li>Request queueing, timeout, and reset handling.</li>
<li>Multiple, lockless queues for sending I/O to block devices.</li>
</ul>
<p>Bdev module creates abstraction layer that provides common API for all devices. User can use available bdev modules or create own module with any type of device underneath (please refer to <a class="el" href="bdev_module.html">Writing a Custom Block Device Module</a> for details). SPDK provides also vbdev modules which creates block devices on existing bdev. For example <a class="el" href="bdev.html#bdev_ug_logical_volumes">Logical volumes</a> or <a class="el" href="bdev.html#bdev_ug_gpt">SPDK GPT partition table</a></p>
<h1><a class="anchor" id="bdev_ug_prerequisites"></a>
Prerequisites</h1>
<p>This guide assumes that you can already build the standard SPDK distribution on your platform. The block device layer is a C library with a single public header file named <a class="el" href="bdev_8h.html" title="Block device abstraction layer. ">bdev.h</a>. All SPDK configuration described in following chapters is done by using JSON-RPC commands. SPDK provides a python-based command line tool for sending RPC commands located at <code>scripts/rpc.py</code>. User can list available commands by running this script with <code>-h</code> or <code>--help</code> flag. Additionally user can retrieve currently supported set of RPC commands directly from SPDK application by running <code>scripts/rpc.py get_rpc_methods</code>. Detailed help for each command can be displayed by adding <code>-h</code> flag as a command parameter.</p>
<h1><a class="anchor" id="bdev_ug_general_rpcs"></a>
General Purpose RPCs</h1>
<h2><a class="anchor" id="bdev_ug_get_bdevs"></a>
get_bdevs</h2>
<p>List of currently available block devices including detailed information about them can be get by using <code>get_bdevs</code> RPC command. User can add optional parameter <code>name</code> to get details about specified by that name bdev.</p>
<p>Example response</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;num_blocks&quot;: 32768,</div><div class="line">  &quot;supported_io_types&quot;: {</div><div class="line">    &quot;reset&quot;: true,</div><div class="line">    &quot;nvme_admin&quot;: false,</div><div class="line">    &quot;unmap&quot;: true,</div><div class="line">    &quot;read&quot;: true,</div><div class="line">    &quot;write_zeroes&quot;: true,</div><div class="line">    &quot;write&quot;: true,</div><div class="line">    &quot;flush&quot;: true,</div><div class="line">    &quot;nvme_io&quot;: false</div><div class="line">  },</div><div class="line">  &quot;driver_specific&quot;: {},</div><div class="line">  &quot;claimed&quot;: false,</div><div class="line">  &quot;block_size&quot;: 4096,</div><div class="line">  &quot;product_name&quot;: &quot;Malloc disk&quot;,</div><div class="line">  &quot;name&quot;: &quot;Malloc0&quot;</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="bdev_ug_delete_bdev"></a>
delete_bdev</h2>
<p>To remove previously created bdev user can use <code>delete_bdev</code> RPC command. Bdev can be deleted at any time and this will be fully handled by any upper layers. As an argument user should provide bdev name. This RPC command should be used only for debugging purpose. To remove a particular bdev please use the delete command specific to its bdev module.</p>
<h1><a class="anchor" id="bdev_config_malloc"></a>
Malloc bdev</h1>
<p>Malloc bdevs are ramdisks. Because of its nature they are volatile. They are created from hugepage memory given to SPDK application.</p>
<h1><a class="anchor" id="bdev_config_nvme"></a>
NVMe bdev</h1>
<p>There are two ways to create block device based on NVMe device in SPDK. First way is to connect local PCIe drive and second one is to connect NVMe-oF device. In both cases user should use <code>construct_nvme_bdev</code> RPC command to achieve that.</p>
<p>Example commands</p>
<p><code>rpc.py construct_nvme_bdev -b NVMe1 -t PCIe -a 0000:01:00.0</code></p>
<p>This command will create NVMe bdev of physical device in the system.</p>
<p><code>rpc.py construct_nvme_bdev -b Nvme0 -t RDMA -a 192.168.100.1 -f IPv4 -s 4420 -n nqn.2016-06.io.spdk:cnode1</code></p>
<p>This command will create NVMe bdev of NVMe-oF resource.</p>
<p>To remove a NVMe controller use the delete_nvme_controller command.</p>
<p><code>rpc.py delete_nvme_controller -t PCIe -a 0000:01:00.0</code></p>
<p>This command will remove NVMe controller representing physical device in the system.</p>
<p><code>rpc.py delete_nvme_controller -t RDMA -a 192.168.100.1 -f IPv4 -s 4420 -n nqn.2016-06.io.spdk:cnode1</code></p>
<p>This command will remove NVMe controller representing NVMe-oF resource.</p>
<p><code>rpc.py delete_nvme_controller -c Nvme0</code></p>
<p>This command will remove NVMe controller named Nvme0.</p>
<p><code>rpc.py delete_nvme_controller -b Nvme0n1</code></p>
<p>This command will remove NVMe controller containing bdev named Nvme0n1.</p>
<h1><a class="anchor" id="bdev_config_null"></a>
Null</h1>
<p>The SPDK null bdev driver is a dummy block I/O target that discards all writes and returns undefined data for reads. It is useful for benchmarking the rest of the bdev I/O stack with minimal block device overhead and for testing configurations that can't easily be created with the Malloc bdev. To create Null bdev RPC command <code>construct_null_bdev</code> should be used.</p>
<p>Example command</p>
<p><code>rpc.py construct_null_bdev Null0 8589934592 4096</code></p>
<p>This command will create an 8 petabyte <code>Null0</code> device with block size 4096.</p>
<p>To delete a null bdev use the delete_null_bdev command.</p>
<p><code>rpc.py delete_null_bdev Null0</code></p>
<h1><a class="anchor" id="bdev_config_aio"></a>
Linux AIO bdev</h1>
<p>The SPDK AIO bdev driver provides SPDK block layer access to Linux kernel block devices or a file on a Linux filesystem via Linux AIO. Note that O_DIRECT is used and thus bypasses the Linux page cache. This mode is probably as close to a typical kernel based target as a user space target can get without using a user-space driver. To create AIO bdev RPC command <code>construct_aio_bdev</code> should be used.</p>
<p>Example commands</p>
<p><code>rpc.py construct_aio_bdev /dev/sda aio0</code></p>
<p>This command will create <code>aio0</code> device from /dev/sda.</p>
<p><code>rpc.py construct_aio_bdev /tmp/file file 8192</code></p>
<p>This command will create <code>file</code> device with block size 8192 from /tmp/file.</p>
<p>To delete an aio bdev use the delete_aio_bdev command.</p>
<p><code>rpc.py delete_aio_bdev aio0</code></p>
<h1><a class="anchor" id="bdev_config_rbd"></a>
Ceph RBD</h1>
<p>The SPDK RBD bdev driver provides SPDK block layer access to Ceph RADOS block devices (RBD). Ceph RBD devices are accessed via librbd and librados libraries to access the RADOS block device exported by Ceph. To create Ceph bdev RPC command <code>construct_rbd_bdev</code> should be used.</p>
<p>Example command</p>
<p><code>rpc.py construct_rbd_bdev rbd foo 512</code></p>
<p>This command will create a bdev that represents the 'foo' image from a pool called 'rbd'.</p>
<p>To remove a block device representation use the delete_rbd_bdev command.</p>
<p><code>rpc.py delete_rbd_bdev Rbd0</code></p>
<h1><a class="anchor" id="bdev_config_gpt"></a>
GPT (GUID Partition Table)</h1>
<p>The GPT virtual bdev driver is enabled by default and does not require any configuration. It will automatically detect <a class="el" href="bdev.html#bdev_ug_gpt">SPDK GPT partition table</a> on any attached bdev and will create possibly multiple virtual bdevs.</p>
<h2><a class="anchor" id="bdev_ug_gpt"></a>
SPDK GPT partition table</h2>
<p>The SPDK partition type GUID is <code>7c5222bd-8f5d-4087-9c00-bf9843c7b58c</code>. Existing SPDK bdevs can be exposed as Linux block devices via NBD and then ca be partitioned with standard partitioning tools. After partitioning, the bdevs will need to be deleted and attached again fot the GPT bdev module to see any changes. NBD kernel module must be loaded first. To create NBD bdev user should use <code>start_nbd_disk</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py start_nbd_disk Malloc0 /dev/nbd0</code></p>
<p>This will expose an SPDK bdev <code>Malloc0</code> under the <code>/dev/nbd0</code> block device.</p>
<p>To remove NBD device user should use <code>stop_nbd_disk</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py stop_nbd_disk /dev/nbd0</code></p>
<p>To display full or specified nbd device list user should use <code>get_nbd_disks</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py stop_nbd_disk -n /dev/nbd0</code></p>
<h2><a class="anchor" id="bdev_ug_gpt_create_part"></a>
Creating a GPT partition table using NBD</h2>
<div class="fragment"><div class="line"># Expose bdev Nvme0n1 as kernel block device /dev/nbd0 by JSON-RPC</div><div class="line">rpc.py start_nbd_disk Nvme0n1 /dev/nbd0</div><div class="line"></div><div class="line"># Create GPT partition table.</div><div class="line">parted -s /dev/nbd0 mklabel gpt</div><div class="line"></div><div class="line"># Add a partition consuming 50% of the available space.</div><div class="line">parted -s /dev/nbd0 mkpart MyPartition &#39;0%&#39; &#39;50%&#39;</div><div class="line"></div><div class="line"># Change the partition type to the SPDK GUID.</div><div class="line"># sgdisk is part of the gdisk package.</div><div class="line">sgdisk -t 1:7c5222bd-8f5d-4087-9c00-bf9843c7b58c /dev/nbd0</div><div class="line"></div><div class="line"># Stop the NBD device (stop exporting /dev/nbd0).</div><div class="line">rpc.py stop_nbd_disk /dev/nbd0</div><div class="line"></div><div class="line"># Now Nvme0n1 is configured with a GPT partition table, and</div><div class="line"># the first partition will be automatically exposed as</div><div class="line"># Nvme0n1p1 in SPDK applications.</div></div><!-- fragment --><h1><a class="anchor" id="bdev_ug_logical_volumes"></a>
Logical volumes</h1>
<p>The Logical Volumes library is a flexible storage space management system. It allows creating and managing virtual block devices with variable size on top of other bdevs. The SPDK Logical Volume library is built on top of <a class="el" href="blob.html">Blobstore Programmer's Guide</a>. For detailed description please refer to <a class="el" href="logical_volumes.html#lvol">Logical volume</a>.</p>
<h2><a class="anchor" id="bdev_ug_lvol_store"></a>
Logical volume store</h2>
<p>Before creating any logical volumes (lvols), an lvol store has to be created first on selected block device. Lvol store is lvols vessel responsible for managing underlying bdev space assigment to lvol bdevs and storing metadata. To create lvol store user should use using <code>construct_lvol_store</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py construct_lvol_store Malloc2 lvs -c 4096</code></p>
<p>This will create lvol store named <code>lvs</code> with cluster size 4096, build on top of <code>Malloc2</code> bdev. In response user will be provided with uuid which is unique lvol store identifier.</p>
<p>User can get list of available lvol stores using <code>get_lvol_stores</code> RPC command (no parameters available).</p>
<p>Example response</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;uuid&quot;: &quot;330a6ab2-f468-11e7-983e-001e67edf35d&quot;,</div><div class="line">  &quot;base_bdev&quot;: &quot;Malloc2&quot;,</div><div class="line">  &quot;free_clusters&quot;: 8190,</div><div class="line">  &quot;cluster_size&quot;: 8192,</div><div class="line">  &quot;total_data_clusters&quot;: 8190,</div><div class="line">  &quot;block_size&quot;: 4096,</div><div class="line">  &quot;name&quot;: &quot;lvs&quot;</div><div class="line">}</div></div><!-- fragment --><p>To delete lvol store user should use <code>destroy_lvol_store</code> RPC command.</p>
<p>Example commands</p>
<p><code>rpc.py destroy_lvol_store -u 330a6ab2-f468-11e7-983e-001e67edf35d</code></p>
<p><code>rpc.py destroy_lvol_store -l lvs</code></p>
<h2><a class="anchor" id="bdev_ug_lvols"></a>
Lvols</h2>
<p>To create lvols on existing lvol store user should use <code>construct_lvol_bdev</code> RPC command. Each created lvol will be represented by new bdev.</p>
<p>Example commands</p>
<p><code>rpc.py construct_lvol_bdev lvol1 25 -l lvs</code></p>
<p><code>rpc.py construct_lvol_bdev lvol2 25 -u 330a6ab2-f468-11e7-983e-001e67edf35d</code></p>
<h1><a class="anchor" id="bdev_config_pmem"></a>
Pmem</h1>
<p>The SPDK pmem bdev driver uses pmemblk pool as the target for block I/O operations. For details on Pmem memory please refer to PMDK documentation on <a href="http://pmem.io">http://pmem.io</a> website. First, user needs to configure SPDK to include PMDK support:</p>
<p><code>configure --with-pmdk</code></p>
<p>To create pmemblk pool for use with SPDK user should use <code>create_pmem_pool</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py create_pmem_pool /path/to/pmem_pool 25 4096</code></p>
<p>To get information on created pmem pool file user can use <code>pmem_pool_info</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py pmem_pool_info /path/to/pmem_pool</code></p>
<p>To remove pmem pool file user can use <code>delete_pmem_pool</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py delete_pmem_pool /path/to/pmem_pool</code></p>
<p>To create bdev based on pmemblk pool file user should use <code>construct_pmem_bdev</code> RPC command.</p>
<p>Example command</p>
<p><code>rpc.py construct_pmem_bdev /path/to/pmem_pool -n pmem</code></p>
<p>To remove a block device representation use the delete_pmem_bdev command.</p>
<p><code>rpc.py delete_pmem_bdev pmem</code></p>
<h1><a class="anchor" id="bdev_config_virtio_scsi"></a>
Virtio SCSI</h1>
<p>The Virtio-SCSI driver allows creating SPDK block devices from Virtio-SCSI LUNs.</p>
<p>The following command creates a Virtio-SCSI device named <code>VirtioScsi0</code> from a vhost-user socket <code>/tmp/vhost.0</code> exposed directly by SPDK <a class="el" href="vhost.html">vhost Target</a>. Optional <code>vq-count</code> and <code>vq-size</code> params specify number of request queues and queue depth to be used.</p>
<p><code>rpc.py construct_virtio_user_scsi_bdev /tmp/vhost.0 VirtioScsi0 --vq-count 2 --vq-size 512</code></p>
<p>The driver can be also used inside QEMU-based VMs. The following command creates a Virtio SCSI device named <code>VirtioScsi0</code> from a Virtio PCI device at address <code>0000:00:01.0</code>. The entire configuration will be read automatically from PCI Configuration Space. It will reflect all parameters passed to QEMU's vhost-user-scsi-pci device.</p>
<p><code>rpc.py construct_virtio_pci_scsi_bdev 0000:00:01.0 VirtioScsi0</code></p>
<p>Each Virtio-SCSI device may export up to 64 block devices named VirtioScsi0t0 ~ VirtioScsi0t63, one LUN (LUN0) per SCSI device. The above 2 commands will output names of all exposed bdevs.</p>
<p>Virtio-SCSI devices can be removed with the following command</p>
<p><code>rpc.py remove_virtio_bdev VirtioScsi0</code></p>
<p>Removing a Virtio-SCSI device will destroy all its bdevs.</p>
<h1><a class="anchor" id="bdev_config_virtio_blk"></a>
Virtio Block</h1>
<p>The Virtio-Block driver can expose an SPDK bdev from a Virtio-Block device.</p>
<p>Virtio-Block bdevs are constructed the same way as Virtio-SCSI ones.</p>
<p><code>rpc.py construct_virtio_user_blk_bdev /tmp/virtio.0 VirtioBlk0 --vq-count 2 --vq-size 512</code></p>
<p><code>rpc.py construct_virtio_pci_blk_bdev 0000:01:00.0 VirtioBlk1</code></p>
<p>Virtio-BLK devices can be removed with the following command</p>
<p><code>rpc.py remove_virtio_bdev VirtioBlk0</code> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</div>
