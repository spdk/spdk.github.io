<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- For Mobile Devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.11">
  <title>SPDK: Block Device Abstraction Layer</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="../css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
    <div class="row no-gutters">
      <div class="col-sm-12">
        <section id="nav">
          <div class="navbar navbar-default navbar-static-top banner-tabs">
            <ul class="nav navbar-nav">
              <li role="presentation">
                <a href="http://www.spdk.io/">
                  <i class="glyphicon glyphicon-home"></i>
                  <span class="box-name">home</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/releases/">
                  <i class="glyphicon glyphicon-download-alt"></i>
                  <span class="box-name">download</span>
                </a>
              </li>
              <li class="active" role="presentation">
                <a href="index.html">
                  <i class="glyphicon glyphicon-book"></i>
                  <span class="box-name">documentation</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/development/">
                  <i class="glyphicon glyphicon-wrench"></i>
                  <span class="box-name">development</span>
                </a>
              </li>
              <li role="presentation">
                <a href="https://ci.spdk.io/">
                  <i class="glyphicon glyphicon-ok"></i>
                  <span class="box-name">CI status</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/community/">
                  <i class="glyphicon glyphicon-envelope"></i>
                  <span class="box-name">community</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/blog/">
                  <i class="glyphicon glyphicon-comment"></i>
                  <span class="box-name">Blog</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/roadmap/">
                  <i class="glyphicon glyphicon-map-marker"></i>
                  <span class="box-name">Roadmap</span>
                </a>
              </li>
              <li role="presentation">
                <a href="http://www.spdk.io/news/">
                  <i class="glyphicon glyphicon-bullhorn"></i>
                  <span class="box-name">News</span>
                </a>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bdev.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Block Device Abstraction Layer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="bdev_getting_started"></a>
SPDK bdev Getting Started Guide</h1>
<p>Block storage in SPDK applications is provided by the SPDK bdev layer. SPDK bdev consists of:</p>
<ul>
<li>a driver module API for implementing bdev drivers</li>
<li>an application API for enumerating and claiming SPDK block devices and performance operations (read, write, unmap, etc.) on those devices</li>
<li>bdev drivers for NVMe, malloc (ramdisk), Linux AIO and Ceph RBD</li>
<li>configuration via SPDK configuration files or JSON RPC</li>
</ul>
<h1><a class="anchor" id="bdev_config"></a>
Configuring block devices</h1>
<p>SPDK block devices are typically configured via an SPDK configuration file. These block devices can then be associated with higher level abstractions such as iSCSI target nodes, NVMe-oF namespaces or vhost-scsi controllers. This section will describe how to configure block devices for the SPDK bdev drivers included with SPDK.</p>
<p>The SPDK configuration file is typically passed to your SPDK-based application via the command line. Refer to the help facility of your application for more details.</p>
<h2><a class="anchor" id="bdev_config_nvme"></a>
NVMe</h2>
<p>The SPDK nvme bdev driver provides SPDK block layer access to NVMe SSDs via the SPDK userspace NVMe driver. The nvme bdev driver binds only to devices explicitly specified. These devices can be either locally attached SSDs or remote NVMe subsystems via NVMe-oF.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Nvme]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # NVMe Device Whitelist</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  # Users may specify which NVMe devices to claim by their transport id.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  # See spdk_nvme_transport_id_parse() in spdk/nvme.h for the correct format.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  # The devices will be assigned names in the format &lt;YourName&gt;nY, where YourName is the</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  # name specified at the end of the TransportId line and Y is the namespace id, which starts at 1.</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  TransportID &quot;trtype:PCIe traddr:0000:00:00.0&quot; Nvme0</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  TransportID &quot;trtype:RDMA adrfam:IPv4 subnqn:nqn.2016-06.io.spdk:cnode1 traddr:192.168.100.1 trsvcid:4420&quot; Nvme1</div></div><!-- fragment --><p>This exports block devices for all namespaces attached to the two controllers. Block devices for namespaces attached to the first controller will be in the format Nvme0nY, where Y is the namespace ID. Most NVMe SSDs have a single namespace with ID=1. Block devices attached to the second controller will be in the format Nvme1nY.</p>
<h2><a class="anchor" id="bdev_config_malloc"></a>
Malloc</h2>
<p>The SPDK malloc bdev driver allocates a buffer of memory in userspace as the target for block I/O operations. This effectively serves as a userspace ramdisk target.</p>
<p>Configuration file syntax: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Malloc]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  NumberOfLuns 4</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  LunSizeInMB  64</div></div><!-- fragment --><p>This exports 4 malloc block devices, named Malloc0 through Malloc3. Each malloc block device will be 64MB in size.</p>
<h2><a class="anchor" id="bdev_config_pmem"></a>
Pmem</h2>
<p>The SPDK pmem bdev driver uses pmemblk pool as the the target for block I/O operations.</p>
<p>First, you need to compile SPDK with NVML: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./configure --with-nvml</div></div><!-- fragment --><p> To create pmemblk pool for use with SPDK use pmempool tool included with NVML: Usage: pmempool create [&lt;args&gt;] &lt;blk|log|obj&gt; [&lt;bsize&gt;] &lt;file&gt;</p>
<p>Example: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./nvml/src/tools/pmempool/pmempool create -s 32000000 blk 512 /path/to/pmem_pool</div></div><!-- fragment --><p>There is also pmem management included in SPDK RPC, it contains three calls:</p><ul>
<li>create_pmem_pool - Creates pmem pool file</li>
<li>delete_pmem_pool - Deletes pmem pool file</li>
<li>pmem_pool_info - Show information if specified file is proper pmem pool file and some detailed information about pool like block size and number of blocks</li>
</ul>
<p>Example: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./scripts/rpc.py create_pmem_pool /path/to/pmem_pool</div></div><!-- fragment --><p> It is possible to create pmem bdev using SPDK RPC: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./scripts/rpc.py construct_pmem_bdev /path/to/pmem_pool</div></div><!-- fragment --><h2><a class="anchor" id="bdev_config_null"></a>
Null</h2>
<p>The SPDK null bdev driver is a dummy block I/O target that discards all writes and returns undefined data for reads. It is useful for benchmarking the rest of the bdev I/O stack with minimal block device overhead and for testing configurations that can't easily be created with the Malloc bdev.</p>
<p>Configuration file syntax: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Null]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # Dev &lt;name&gt; &lt;size_in_MiB&gt; &lt;block_size&gt;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  # Create an 8 petabyte null bdev with 4K block size called Null0</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  Dev Null0 8589934592 4096</div></div><!-- fragment --><h2><a class="anchor" id="bdev_config_aio"></a>
Linux AIO</h2>
<p>The SPDK aio bdev driver provides SPDK block layer access to Linux kernel block devices via Linux AIO. Note that O_DIRECT is used and thus bypasses the Linux page cache. This mode is probably as close to a typical kernel based target as a user space target can get without using a user-space driver.</p>
<p>Configuration file syntax:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[AIO]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # AIO &lt;file name&gt; &lt;bdev name&gt; [&lt;block size&gt;]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  # The file name is the backing device</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  # The bdev name can be referenced from elsewhere in the configuration file.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  # Block size may be omitted to automatically detect the block size of a disk.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  AIO /dev/sdb AIO0</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  AIO /dev/sdc AIO1</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  AIO /tmp/myfile AIO2 4096</div></div><!-- fragment --><p>This exports 2 aio block devices, named AIO0 and AIO1.</p>
<h2><a class="anchor" id="bdev_config_rbd"></a>
Ceph RBD</h2>
<p>The SPDK rbd bdev driver provides SPDK block layer access to Ceph RADOS block devices (RBD). Ceph RBD devices are accessed via librbd and librados libraries to access the RADOS block device exported by Ceph.</p>
<p>Configuration file syntax:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Ceph]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # The format of provided rbd info should be: Ceph rbd_pool_name rbd_name size.</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  # In the following example, rbd is the name of rbd_pool; foo is the name of</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  # rbd device exported by Ceph; value 512 represents the configured block size</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  # for this rbd, the block size should be a multiple of 512.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  Ceph rbd foo 512</div></div><!-- fragment --><p>This exports 1 rbd block device, named Ceph0.</p>
<h2><a class="anchor" id="bdev_config_virtio_scsi"></a>
Virtio SCSI</h2>
<p>The SPDK Virtio SCSI driver allows creating SPDK block devices from Virtio SCSI LUNs.</p>
<p>Use the following configuration file snippet to bind all available Virtio-SCSI PCI devices on a virtual machine. The driver will perform a target scan on each device and automatically create block device for each LUN.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[VirtioPci]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # If enabled, the driver will automatically use all available Virtio-SCSI PCI</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  # devices. Disabled by default.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  Enable Yes</div></div><!-- fragment --><p>The driver also supports connecting to vhost-user devices exposed on the same host. In the following case, the host app has created a vhost-scsi controller which is accessible through the /tmp/vhost.0 domain socket.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[VirtioUser0]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # Path to the Unix domain socket using vhost-user protocol.</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  Path /tmp/vhost.0</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  # Maximum number of request queues to use. Default value is 1.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  Queues 1</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;#[VirtioUser1]</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  #Path /tmp/vhost.1</div></div><!-- fragment --><p>Each Virtio-SCSI device may export up to 64 block devices named VirtioScsi0t0 ~ VirtioScsi0t63.</p>
<h2><a class="anchor" id="bdev_config_gpt"></a>
GPT (GUID Partition Table)</h2>
<p>The GPT virtual bdev driver examines all bdevs as they are added and exposes partitions with a SPDK-specific partition type as bdevs. The SPDK partition type GUID is <code>7c5222bd-8f5d-4087-9c00-bf9843c7b58c</code>.</p>
<p>Configuration file syntax:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Gpt]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  # If Gpt is disabled, it will not automatically expose GPT partitions as bdevs.</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  Disable No</div></div><!-- fragment --><h3>Creating a GPT partition table using NBD</h3>
<p>The bdev NBD app can be used to temporarily expose an SPDK bdev through the Linux kernel block stack so that standard partitioning tools can be used.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Expose bdev Nvme0n1 as kernel block device /dev/nbd0</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;# Assumes bdev.conf is already configured with a bdev named Nvme0n1 -</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;# see the NVMe section above.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;test/lib/bdev/nbd/nbd -c bdev.conf -b Nvme0n1 -n /dev/nbd0 &amp;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;nbd_pid=$!</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;# Create GPT partition table.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;parted -s /dev/nbd0 mklabel gpt</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;# Add a partition consuming 50% of the available space.</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;parted -s /dev/nbd0 mkpart MyPartition &#39;0%&#39; &#39;50%&#39;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;# Change the partition type to the SPDK GUID.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;# sgdisk is part of the gdisk package.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;sgdisk -t 1:7c5222bd-8f5d-4087-9c00-bf9843c7b58c /dev/nbd0</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;# Kill the NBD application (stop exporting /dev/nbd0).</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;kill $nbd_pid</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;# Now Nvme0n1 is configured with a GPT partition table, and</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;# the first partition will be automatically exposed as</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;# Nvme0n1p1 in SPDK applications.</div></div><!-- fragment --><h2>Logical Volumes</h2>
<p>The SPDK lvol driver allows to dynamically partition other SPDK backends. No static configuration for this driver. Refer to <a class="el" href="logical_volumes.html#lvol">Logical volume</a> for detailed RPC configuration. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</div>
