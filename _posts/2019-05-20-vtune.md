---
layout: post
title:  "VTune and mempools"
author: Piotr Pelplinski
categories: news
---


VTune Amplifier now supports additional SPDK statistics including mempools and throuput and latency histograms.
This article shows how to configure and show them.

# SPDK Compilation

To use SPDK with VTune you need to first compile spdk with the support for VTune metadata.

Download SPDK and VTune Amplifier to remote machine.
Unpack VTune to some directory, and provide that directory to spdk in configure:
```
./configure --with-vtune=../path/to/vtune_amplifier
```
Then, you can compile spdk on the remote machine with VTune support.



# VTune configuration

On the client machine, click Configuration Analysis tab.
You need to specify your remote machine and temporary directories for VTune.
![SPDK](../../../../../img/_configuration1.jpg "Configure Analysis")



# Sample test configuration

To demonstrate this functionality we will use SPDK sample application bdevperf.

In Launch Application section provide path to bdevperf in spdk repository and application parameters
For example:

`/path/to/spdk/test/bdev/bdevperf/bdevperf`

Application parameters:

`-c /path/to/bdevperf.conf -q 512 -o 512 -w read -t 5 -r /var/tmp/spdk.sock`

Also, you need to provide bdevperf.conf file.

```
[AIO]
AIO /home/ppelplin/aio.bdev AIO0 512

[Bdev]
BdevIoPoolSize 512
```

To show saturation of Bdev IO Pool we have set BdevIoPoolSize to 512, and queue size (-q parameter) to the same value.

To configure additional counters open “Input and Output” analysis type. Select SPDK profiling and create custom Analysis type from this one. Enable counter API support in custom Analysis type. Run collection for new analysis. Then, you can check global counter values on timeline of Sample count or Platform views

![SPDK](../../../../../img/_vtune1.jpg "Sample Count view")

Identify SPDK Mempools Saturation

The additional counters show the number of free elements in mempool, so if the counters are close to zero it means that pool is saturated.
Select the time frame with lowest value of mempools to show functions that consume those pools.

Switch to the Summary view to show trougput histogram.
![SPDK](../../../../../img/_vtune_troughput.jpg", "VTune troughput")

